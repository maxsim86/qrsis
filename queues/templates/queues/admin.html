{% extends 'base.html' %}
{% block content %}

<style>
    /* CSS Khas Admin */
    body { background-color: #f3f4f6; margin: 0; padding: 0; min-height: 100vh; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
    .mobile-app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background-color: #ffffff; box-shadow: 0 0 30px rgba(0,0,0,0.1); display: flex; flex-direction: column; padding: 20px; }
    
    /* Header & Status */
    .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .queue-name { font-size: 1.1rem; font-weight: 700; color: #1f2937; }
    .status-card { background-color: #1f2937; color: white; border-radius: 25px; padding: 30px 20px; text-align: center; margin-top: 10px; margin-bottom: auto; }
    .status-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; }
    .status-number { font-size: 6rem; font-weight: 800; line-height: 1; margin: 15px 0; }
    
    /* Buttons */
    .controls-area { margin-top: 30px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px; }
    .btn-app { width: 100%; padding: 15px; border-radius: 15px; border: none; font-weight: 700; font-size: 1rem; cursor: pointer; text-decoration: none; display: flex; justify-content: center; align-items: center; }
    .btn-primary-app { background-color: #3b82f6; color: white; font-size: 1.1rem; padding: 18px; }
    .btn-secondary-app { background-color: #f3f4f6; color: #1f2937; }
    .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    /* Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; display: none; align-items: flex-end; justify-content: center; }
    .modal-sheet { background: white; width: 100%; max-width: 480px; border-radius: 25px 25px 0 0; padding: 25px; max-height: 80vh; display: flex; flex-direction: column; animation: slideUp 0.3s ease-out; }
    @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }

    /* Selection Actions */
    .selection-actions { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; display: none; flex-direction: column; gap: 10px; }

    /* Visitor Grid dalam Modal */
    .visitor-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; overflow-y: auto; padding-bottom: 10px; }
    .btn-num { background: #fff; border: 2px solid #e5e7eb; border-radius: 12px; padding: 12px 0; font-weight: 700; color: #374151; font-size: 1rem; cursor: pointer; }
    .btn-num.selected { background-color: #eff6ff; border-color: #3b82f6; color: #2563eb; }
</style>

<div class="mobile-app-container">
    
    <div class="app-header">
        <div class="queue-name">{{ queue.name|truncatechars:20 }}</div>
        <button onclick="openSettingsModal()" class="btn-app btn-secondary-app" style="width: 45px; height: 45px; padding: 0;">‚öôÔ∏è</button>
    </div>

    <div id="htmx-controller"
         hx-get="{% url 'get_admin_updates' queue.slug %}"
         hx-trigger="queue_update from:body, load">
    </div>

    <div id="status-card-area" class="status-card">
        <div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div>
    </div>

    <div id="controls-area" class="controls-area">
        <div class="spinner-border text-primary mx-auto" role="status"></div>
    </div>

</div>

<div id="numberModal" class="modal-overlay">
    <div class="modal-sheet">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold m-0">Pilih Pelawat</h5>
            <button onclick="closeModals()" class="btn-close"></button>
        </div>

        <div class="d-flex gap-2 mb-3 overflow-auto" style="white-space: nowrap;">
            <button class="btn btn-sm btn-dark px-3 rounded-pill"
                    hx-get="{% url 'search_visitors' queue.slug %}?type=ALL"
                    hx-target="#visitor-list-container">
                Semua
            </button>

            <button class="btn btn-sm btn-primary px-3 rounded-pill"
                    hx-get="{% url 'search_visitors' queue.slug %}?type=A"
                    hx-target="#visitor-list-container">
                üìù A
            </button>

            <button class="btn btn-sm btn-success px-3 rounded-pill"
                    hx-get="{% url 'search_visitors' queue.slug %}?type=B"
                    hx-target="#visitor-list-container">
                üí∞ B
            </button>

            <button class="btn btn-sm btn-info text-white px-3 rounded-pill"
                    hx-get="{% url 'search_visitors' queue.slug %}?type=C"
                    hx-target="#visitor-list-container">
                ‚ùì C
            </button>
        </div>

        <input type="search" 
               class="form-control form-control-lg bg-light border-0 mb-3" 
               placeholder="Cari nombor..." 
               name="q"
               hx-get="{% url 'search_visitors' queue.slug %}"
               hx-trigger="keyup changed delay:500ms, queue_update from:body" 
               hx-target="#visitor-list-container">

        <div id="visitor-list-container" style="flex: 1; overflow-y: auto;">
             {% include 'queues/partials/visitor_list.html' %}
        </div>

        </div>
</div>

<div id="addModal" class="modal-overlay">
    <div class="modal-sheet">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold m-0">Tambah Manual</h5>
            <button onclick="closeModals()" class="btn-close"></button>
        </div>
        <form hx-post="{% url 'add_manual_visitor' queue.slug %}" hx-swap="none" onsubmit="closeModals()">
            {% csrf_token %}
            <div class="mb-3">
                <label class="fw-bold small text-muted">JENIS SERVIS</label>
                <select name="service_type" class="form-select form-select-lg bg-light border-0">
                    <option value="A" selected>üìù A - Pendaftaran</option>
                    <option value="B">üí∞ B - Pembayaran</option>
                    <option value="C">‚ùì C - Pertanyaan</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="fw-bold small text-muted">NAMA (PILIHAN)</label>
                <input type="text" name="custom_name" class="form-control form-control-lg bg-light border-0" placeholder="Contoh: Ali">
            </div>
            <button type="submit" class="btn btn-primary w-100 py-3 rounded-pill fw-bold">Cetak Tiket</button>
        </form>
    </div>
</div>

<div id="confirmModal" class="modal-overlay">
    <div class="modal-sheet text-center">
         <div class="py-4">
            <h3 class="fw-bold mb-3">Kembali ke Queue?</h3>
            <p class="text-muted">Hantar <strong id="returnNum" class="text-dark">---</strong> ke barisan belakang?</p>
            <div class="d-grid gap-2 mt-4">
                <a id="confirmYesBtn" href="#" class="btn btn-primary btn-lg rounded-pill">Ya, Kembalikan</a>
                <button onclick="closeModals()" class="btn btn-light btn-lg rounded-pill">Batal</button>
            </div>
        </div>
    </div>
</div>

<div id="removeModal" class="modal-overlay">
    <div class="modal-sheet text-center">
        <div class="py-4">
            <h3 class="fw-bold text-danger mb-3">Clear Queue?</h3>
            <p class="text-muted">Tindakan ini memadam <strong>SEMUA</strong> pelawat menunggu.</p>
            <form action="{% url 'remove_visitors' queue.slug %}" method="POST" class="d-grid gap-2 mt-4">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger btn-lg rounded-pill">Ya, Padam Semua</button>
                <button type="button" onclick="closeModals()" class="btn btn-light btn-lg rounded-pill">Batal</button>
            </form>
        </div>
    </div>
</div>

<div id="settingsModal" class="modal-overlay">
    <div class="modal-sheet">
         <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold m-0">Settings</h5>
            <button onclick="closeModals()" class="btn-close"></button>
        </div>
        {% include 'queues/partials/settings_form.html' %}
    </div>
</div>

<script>
    // --- UI HELPERS ---
    function closeModals() {
        document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none');
        resetSelection();
    }
    
    window.openNumberModal = () => document.getElementById('numberModal').style.display = 'flex';
    window.openAddModal = () => document.getElementById('addModal').style.display = 'flex';
    window.openSettingsModal = () => document.getElementById('settingsModal').style.display = 'flex';
    window.openRemoveModal = () => { closeModals(); document.getElementById('removeModal').style.display = 'flex'; }
    
    window.showConfirmModal = (id, num) => {
        document.getElementById('returnNum').innerText = num;
        document.getElementById('confirmYesBtn').href = "/q/visitor/" + id + "/return/";
        document.getElementById('confirmModal').style.display = 'flex';
    }

    // Logic Pilih Pelawat & Set HTMX Button
    window.selectVisitor = (btnElement, id, number) => {
        document.querySelectorAll('.btn-num').forEach(el => el.classList.remove('selected'));
        if(btnElement) btnElement.classList.add('selected');
        
        document.getElementById('selection-actions').style.display = 'flex';
        document.getElementById('selected-number-display').innerText = number;
        
        // Setup HTMX Buttons secara dinamik
        let callBtn = document.getElementById('btn-call-selected');
        let removeBtn = document.getElementById('btn-remove-selected');

        callBtn.setAttribute('hx-get', `/q/visitor/${id}/invite/`);
        callBtn.setAttribute('hx-swap', 'none'); 
        htmx.process(callBtn); // Refresh HTMX binding

        removeBtn.setAttribute('hx-get', `/q/visitor/${id}/remove/`);
        removeBtn.setAttribute('hx-swap', 'none');
        htmx.process(removeBtn);
    }

    function resetSelection() {
        document.querySelectorAll('.btn-num').forEach(el => el.classList.remove('selected'));
        document.getElementById('selection-actions').style.display = 'none';
    }

    window.copyToClipboard = (text) => {
        navigator.clipboard.writeText(text).then(() => alert("Copied!"));
    }

    // --- WEBSOCKET ---
    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const socket = new WebSocket(protocol + window.location.host + '/ws/queue/{{ queue.slug }}/');

    socket.onmessage = function(e) {
        // Trigger global event untuk update semua HTMX elements (Search list & Dashboard)
        document.body.dispatchEvent(new Event('queue_update'));
    };
    
    socket.onclose = () => setTimeout(() => location.reload(), 3000);
</script>

{% endblock %}