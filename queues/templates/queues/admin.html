{% extends 'base.html' %}
{% block content %}

<style>
    /* --- 1. GLOBAL LAYOUT & RESET --- */
    body { 
        background-color: #f3f4f6; 
        min-height: 100vh; 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
    }

    /* Main Container */
    .admin-container { 
        width: 100%;
        max-width: 1000px;
        margin: 0 auto; 
        min-height: 100vh; 
        background-color: #ffffff; 
        display: flex; 
        flex-direction: column; 
        padding: 20px; 
        box-sizing: border-box;
    }
    
    /* Desktop View Tweaks */
    @media (min-width: 768px) {
        .admin-container {
            margin: 40px auto;
            min-height: auto;
            border-radius: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.05);
            padding: 40px;
        }
    }

    /* --- 2. HEADER & DASHBOARD --- */
    .app-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 30px; 
    }
    .queue-name { font-size: 1.25rem; font-weight: 800; color: #111827; }

    /* Dashboard Grid */
    .dashboard-grid {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    @media (min-width: 768px) {
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            align-items: start;
            gap: 40px;
        }
    }

    /* Status Card (Kiri) */
    .status-card { 
        background: linear-gradient(145deg, #1f2937, #111827); 
        color: white; 
        border-radius: 25px; 
        padding: 40px 20px; 
        text-align: center; 
        box-shadow: 0 15px 30px rgba(0,0,0,0.2); 
    }
    .status-label { font-size: 0.85rem; letter-spacing: 1.5px; opacity: 0.8; font-weight: 600; text-transform: uppercase; }
    .status-number { font-size: clamp(5rem, 10vw, 7rem); font-weight: 800; line-height: 1.1; margin: 15px 0; letter-spacing: -3px; }

    /* Controls Area (Kanan) */
    .controls-area { display: flex; flex-direction: column; gap: 15px; }
    
    /* Global Button Styles (untuk partials) */
    .btn-app { 
        width: 100%; padding: 18px; border: none; border-radius: 18px; 
        font-size: 1rem; font-weight: 700; cursor: pointer; 
        transition: transform 0.1s, box-shadow 0.2s; text-decoration: none; 
        display: flex; justify-content: center; align-items: center; 
    }
    .btn-app:active { transform: scale(0.98); }
    .btn-primary-app { background-color: #3b82f6; color: white; box-shadow: 0 8px 20px -5px rgba(59, 130, 246, 0.5); font-size: 1.1rem; }
    .btn-secondary-app { background-color: #f3f4f6; color: #1f2937; border: 1px solid #e5e7eb; }
    .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

    /* --- 3. MODAL SYSTEM --- */
    .modal-overlay { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.6); z-index: 1000; 
        display: none; align-items: flex-end; justify-content: center;
        backdrop-filter: blur(5px);
    }
    .modal-sheet { 
        background: white; width: 100%; 
        border-top-left-radius: 25px; border-top-right-radius: 25px; 
        padding: 25px; max-height: 85vh; 
        display: flex; flex-direction: column; 
        animation: slideUp 0.3s ease-out; 
    }
    @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }
    @keyframes fadeInScale { from {opacity: 0; transform: scale(0.95);} to {opacity: 1; transform: scale(1);} }

    @media (min-width: 640px) {
        .modal-overlay { align-items: center; }
        .modal-sheet {
            max-width: 500px; border-radius: 25px;
            animation: fadeInScale 0.2s ease-out;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
    }

    /* --- 4. MODERN SELECT MODAL STYLES (NEW) --- */
    .modal-header-custom {
        padding-bottom: 20px;
        border-bottom: 1px solid #f3f4f6;
        margin-bottom: 20px;
    }
    /* Search Input */
    .search-input-modern {
        background-color: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 12px 15px 12px 45px;
        width: 100%; transition: all 0.2s;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%239ca3af' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat; background-position: 15px center;
    }
    .search-input-modern:focus {
        background-color: #fff; border-color: #3b82f6; outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    /* Filter Chips */
    .filter-scroll {
        display: flex; gap: 10px; overflow-x: auto;
        padding-bottom: 5px; scrollbar-width: none;
    }
    .filter-scroll::-webkit-scrollbar { display: none; }
    .filter-chip {
        background: #fff; border: 1px solid #e5e7eb; color: #4b5563;
        padding: 8px 20px; border-radius: 50px; font-size: 0.9rem; font-weight: 600;
        cursor: pointer; transition: all 0.2s; white-space: nowrap;
    }
    .filter-chip:hover { background: #f3f4f6; }
    .filter-chip.active { background: #111827; color: #fff; border-color: #111827; }
    /* Dots */
    .dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
    .dot-a { background-color: #3b82f6; }
    .dot-b { background-color: #10b981; }
    .dot-c { background-color: #06b6d4; }

    /* Utility Buttons */
    .btn-settings-app { 
        width: 45px; height: 45px; background-color: #f3f4f6; border: none; 
        border-radius: 12px; display: flex; align-items: center; justify-content: center; 
        cursor: pointer; font-size: 1.2rem; transition: background 0.2s;
    }
    .btn-settings-app:hover { background-color: #e5e7eb; }

    /* HTMX Fade Animation */
    .fade-row { transition: opacity 0.5s, transform 0.5s; }
    .htmx-swapping .fade-row { opacity: 0; transform: translateX(20px); }



    .visitor-grid-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 12px;
    padding: 5px;
}

/* REKA BENTUK KAD PELAWAT */
    /* REKA BENTUK KAD PELAWAT */
.visitor-card {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    transition: all 0.2s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    position: relative;
    overflow: hidden;
}

/* Hover Effect */
.visitor-card:hover {
    transform: translateY(-2px);
    border-color: #3b82f6;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
}

/* Header Kad (Nombor Tiket) */
.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.ticket-tag {
    font-weight: 800;
    font-size: 1.1rem;
    color: #1f2937;
    background: #f3f4f6;
    padding: 4px 8px;
    border-radius: 6px;
}

/* Nama Pelawat */
.visitor-name-box {
    font-size: 0.9rem;
    color: #4b5563;
    margin-bottom: 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Footer Kad (Butang) */
.card-actions {
    display: flex;
    gap: 8px;
    margin-top: auto; /* Tolak butang ke bawah */
}

.btn-card {
    flex: 1;
    border: none;
    border-radius: 8px;
    padding: 6px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
}

.btn-card-call { background: #eff6ff; color: #2563eb; }
.btn-card-call:hover { background: #3b82f6; color: white; }

.btn-card-del { background: #fef2f2; color: #ef4444; width: 35px; flex: none; }
.btn-card-del:hover { background: #ef4444; color: white; }

/* Animasi HTMX Fade Out */
.fade-me-out.htmx-swapping {
    opacity: 0;
    transform: scale(0.9);
    transition: all 0.5s ease-out;
}

/* RADIO CARDS (Ganti Dropdown) */
.service-selection-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* 3 kotak sebaris */
    gap: 10px;
    margin-bottom: 20px;
}

/* Sembunyikan bulat radio button asal */
.service-radio-input { display: none; }

/* Design Label sebagai Kad */
.service-card-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 15px 5px;
    background: #f9fafb;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    color: #6b7280;
    font-weight: 600;
    text-align: center;
}

.service-card-label:hover { background: #f3f4f6; transform: translateY(-2px); }

/* Bila Dipilih (Checked State) - Warna ikut jenis */
.service-radio-input:checked + .service-card-label {
    background: #eff6ff;
    border-color: #3b82f6;
    color: #2563eb;
    box-shadow: 0 4px 6px rgba(37, 99, 235, 0.1);
}

/* Warna Khas untuk B dan C */
#srvB:checked + .service-card-label { background: #ecfdf5; border-color: #10b981; color: #059669; }
#srvC:checked + .service-card-label { background: #ecfeff; border-color: #06b6d4; color: #0891b2; }

.srv-icon { font-size: 1.5rem; margin-bottom: 5px; }

/* LOADING BUTTON */
.htmx-request .btn-content { display: none; }
.htmx-request .spinner-loader { display: inline-block; }
.spinner-loader { display: none; width: 1rem; height: 1rem; border: 2px solid #fff; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; }
@keyframes spin { to {transform: rotate(360deg);} }

</style>

<div class="admin-container">
    
    <div class="app-header">
        <div class="queue-name">{{ queue.name|truncatechars:20 }}</div>
        <div class="d-flex gap-2">
            <a href="{% url 'queue_stats' queue.slug %}" class="btn-settings-app text-decoration-none" style="background-color: #ecfdf5; color: #059669;" title="Statistik">
                üìä
            </a>
            <button onclick="openSettingsModal()" class="btn-settings-app" title="Tetapan">
                ‚öôÔ∏è
            </button>
        </div>
    </div>

    <div id="htmx-controller"
         hx-get="{% url 'get_admin_updates' queue.slug %}"
         hx-trigger="queue_update from:body, load">
    </div>

    <div class="dashboard-grid">
        <div id="status-card-area" class="status-card">
            <div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div>
        </div>

        <div id="controls-area" class="controls-area">
            <div class="spinner-border text-primary mx-auto" role="status"></div>
        </div>
    </div>
</div>

<div id="numberModal" class="modal-overlay">
    <div class="modal-sheet">
        
        <div class="modal-header-custom">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="fw-bold m-0 text-dark">Pilih Pelawat</h4>
                <button onclick="closeModals()" class="btn-close"></button>
            </div>

            <div class="filter-scroll mb-3">
                <button class="filter-chip active" hx-get="{% url 'search_visitors' queue.slug %}?type=ALL" hx-target="#visitor-list-container">
                    Semua
                </button>
                <button class="filter-chip" hx-get="{% url 'search_visitors' queue.slug %}?type=A" hx-target="#visitor-list-container">
                    <span class="dot dot-a"></span>Pendaftaran
                </button>
                <button class="filter-chip" hx-get="{% url 'search_visitors' queue.slug %}?type=B" hx-target="#visitor-list-container">
                    <span class="dot dot-b"></span>Bayaran
                </button>
                <button class="filter-chip" hx-get="{% url 'search_visitors' queue.slug %}?type=C" hx-target="#visitor-list-container">
                    <span class="dot dot-c"></span>Lain-lain
                </button>
            </div>

            <input type="search" 
                   class="search-input-modern" 
                   placeholder="Cari nama atau nombor..." 
                   name="q"
                   id="searchInput"
                   hx-get="{% url 'search_visitors' queue.slug %}"
                   hx-trigger="keyup changed delay:500ms, queue_update from:body" 
                   hx-target="#visitor-list-container">
        </div>

        <div id="visitor-list-container" style="flex: 1; overflow-y: auto; padding: 0 5px;">
             {% include 'queues/partials/visitor_list.html' %}
        </div>

    </div>
</div>

<div id="addModal" class="modal-overlay">
    <div class="modal-sheet">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="fw-bold m-0 text-dark">Tambah Manual</h5>
            <button onclick="closeModals()" class="btn-close"></button>
        </div>

        <form id="manualAddForm"
              hx-post="{% url 'add_manual_visitor' queue.slug %}" 
              hx-swap="none"
              hx-indicator="#submit-btn"
              hx-on::after-request="this.reset(); closeModals();">
            
            {% csrf_token %}

            <label class="fw-bold small text-muted mb-2">PILIH SERVIS</label>
            
            <div class="service-selection-grid">
                <input type="radio" name="service_type" value="A" id="srvA" class="service-radio-input" checked>
                <label for="srvA" class="service-card-label">
                    <span class="srv-icon">üìù</span>
                    <span>Daftar</span>
                </label>

                <input type="radio" name="service_type" value="B" id="srvB" class="service-radio-input">
                <label for="srvB" class="service-card-label">
                    <span class="srv-icon">üí∞</span>
                    <span>Bayar</span>
                </label>

                <input type="radio" name="service_type" value="C" id="srvC" class="service-radio-input">
                <label for="srvC" class="service-card-label">
                    <span class="srv-icon">‚ùì</span>
                    <span>Lain2</span>
                </label>
            </div>

            <div class="mb-4">
                <label class="fw-bold small text-muted mb-2">NAMA PELAWAT (PILIHAN)</label>
                <input type="text" 
                       name="custom_name" 
                       class="form-control form-control-lg bg-light border-0" 
                       placeholder="Contoh: Ahmad (Kosongkan jika tiada)">
            </div>

            <button type="submit" id="submit-btn" class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow-sm">
                <span class="btn-content">üñ®Ô∏è Cetak Tiket</span>
                <span class="spinner-loader"></span> </button>

        </form>
    </div>
</div>




<div id="confirmModal" class="modal-overlay">
    <div class="modal-sheet text-center">
         <div class="py-4">
            <h3 class="fw-bold mb-3">Kembali ke Queue?</h3>
            <p class="text-muted">Hantar <strong id="returnNum" class="text-dark">---</strong> ke barisan belakang?</p>
            <div class="d-grid gap-2 mt-4">
                <a id="confirmYesBtn" href="#" class="btn btn-primary btn-lg rounded-pill">Ya, Kembalikan</a>
                <button onclick="closeModals()" class="btn btn-light btn-lg rounded-pill">Batal</button>
            </div>
        </div>
    </div>
</div>

<div id="removeModal" class="modal-overlay">
    <div class="modal-sheet text-center">
        <div class="py-4">
            <h3 class="fw-bold text-danger mb-3">Kosongkan Q?</h3>
            <p class="text-muted">Tindakan ini memadam <strong>SEMUA</strong> pelawat menunggu.</p>
            <form action="{% url 'remove_visitors' queue.slug %}" method="POST" class="d-grid gap-2 mt-4">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger btn-lg rounded-pill">Ya, Padam Semua</button>
                <button type="button" onclick="closeModals()" class="btn btn-light btn-lg rounded-pill">Batal</button>
            </form>
        </div>
    </div>
</div>

<div id="settingsModal" class="modal-overlay">
    <div class="modal-sheet">
         <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold m-0">Settings</h5>
            <button onclick="closeModals()" class="btn-close"></button>
        </div>
        {% include 'queues/partials/settings_form.html' %}
    </div>
</div>
<script>

document.body.addEventListener('ticketCreated', function(evt) {
    const data = evt.detail; // Dapat data dari views.py
    
    // Tutup Modal dulu
    closeModals();
    
    // Papar Popup Cantik
    Swal.fire({
        title: 'Berjaya!',
        text: 'Tiket ' + data.number + ' telah dicetak.',
        icon: 'success',
        timer: 2000, // Tutup sendiri lepas 2 saat
        showConfirmButton: false,
        backdrop: `rgba(0,0,123,0.4)`
    });
    
    // Reset form (Optional, jika htmx tak reset)
    document.getElementById('manualAddForm').reset();
});


    // 1. UI HELPERS (Modals)
    function closeModals() {
        document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none');
    }
    
    // Open Functions
    window.openNumberModal = () => {
        document.getElementById('numberModal').style.display = 'flex';
        // Auto focus ke search input
        setTimeout(() => document.getElementById('searchInput').focus(), 100); 
    };
    window.openAddModal = () => document.getElementById('addModal').style.display = 'flex';
    window.openSettingsModal = () => document.getElementById('settingsModal').style.display = 'flex';
    window.openRemoveModal = () => { closeModals(); document.getElementById('removeModal').style.display = 'flex'; }
    
    window.showConfirmModal = (id, num) => {
        document.getElementById('returnNum').innerText = num;
        document.getElementById('confirmYesBtn').href = "/q/visitor/" + id + "/return/";
        document.getElementById('confirmModal').style.display = 'flex';
    }

    // 2. WEBSOCKET SETUP
    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const socket = new WebSocket(protocol + window.location.host + '/ws/queue/{{ queue.slug }}/');

    socket.onmessage = function(e) {
        console.log("Websocket update received");
        // Trigger HTMX update pada body
        document.body.dispatchEvent(new Event('queue_update'));
    };
    
    socket.onclose = () => {
        console.log("Socket disconnected");
        setTimeout(() => location.reload(), 3000); // Auto reconnect refresh
    };

    // 3. LIVE TIMER LOGIC (Untuk Pelawat Sedang Dilayan)
    function formatTime(seconds) {
        const m = Math.floor(seconds / 60).toString().padStart(2, '0');
        const s = Math.floor(seconds % 60).toString().padStart(2, '0');
        return `${m}:${s}`;
    }

    setInterval(() => {
        const timers = document.querySelectorAll('.live-timer');
        timers.forEach(timer => {
            const startTimeStr = timer.getAttribute('data-start');
            if (!startTimeStr) return;
            const startTime = new Date(startTimeStr).getTime();
            const now = new Date().getTime();
            const diffInSeconds = Math.floor((now - startTime) / 1000);
            
            if (diffInSeconds >= 0) {
                timer.innerText = formatTime(diffInSeconds);
                if (diffInSeconds > 600) timer.style.color = '#ff6b6b'; // Merah jika > 10 min
            }
        });
    }, 1000);

    // 4. KEYBOARD SHORTCUTS
    document.addEventListener('keydown', function(event) {
        
        // Elak conflict jika modal sedang dibuka (Kecuali ESC)
        if (document.querySelector('.modal-overlay[style*="display: flex"]')) {
            if (event.key === "Escape") closeModals();
            return; 
        }

        switch (event.code) {
            case 'Enter':        
            case 'NumpadEnter':  
                event.preventDefault(); 
                triggerClick('btn-next'); // Pastikan ID ini wujud dalam admin_board.html
                break;

            case 'Space':        
            case 'Numpad0':      
                event.preventDefault();
                triggerClick('btn-recall'); // Pastikan ID ini wujud dalam admin_board.html
                break;

            case 'NumpadAdd':
                triggerClick('btn-add'); // ID butang dalam admin_board.html
                break;
                
            case 'KeyS':         
            case 'NumpadDecimal': 
                event.preventDefault(); 
                openNumberModal(); 
                break;
        }
    });

    function triggerClick(elementId) {
        const btn = document.getElementById(elementId);
        if (btn) {
            btn.click();
            // Visual Effect
            btn.style.transform = "scale(0.95)";
            setTimeout(() => btn.style.transform = "scale(1)", 100);
        }
    }
</script>

{% endblock %}
