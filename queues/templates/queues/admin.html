{% extends 'base.html' %}
{% block content %}


<style>
    /* --- CSS (Sama seperti design asal) --- */
    body { background-color: #f3f4f6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; min-height: 100vh; }
    .mobile-app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background-color: #ffffff; box-shadow: 0 0 30px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: space-between; padding: 20px; box-sizing: border-box; }
    .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .queue-name { font-size: 1.1rem; font-weight: 700; color: #1f2937; }
    
    .btn-settings-app { width: 48px; height: 48px; background-color: #e0f2fe; color: #0284c7; border: none; border-radius: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.1s; }
    .btn-settings-app:active { transform: scale(0.95); }

    /* Placeholder Status Card */
    .status-card { background-color: #1f2937; color: white; border-radius: 25px; padding: 40px 20px; text-align: center; box-shadow: 0 15px 30px rgba(0,0,0,0.2); margin-bottom: auto; margin-top: 20px; }
    .status-label { text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1.5px; opacity: 0.7; font-weight: 600; }
    .status-number { font-size: 7rem; font-weight: 800; line-height: 1.1; margin: 10px 0; letter-spacing: -3px; }
    .status-sub { font-size: 1rem; color: #9ca3af; }
    .status-sub strong { color: #fff; }

    /* Controls */
    .controls-area { display: flex; flex-direction: column; gap: 12px; margin-top: 30px; margin-bottom: 20px; }
    .btn-app { width: 100%; padding: 16px; border: none; border-radius: 16px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: transform 0.1s; text-decoration: none; display: flex; justify-content: center; align-items: center; }
    .btn-app:active { transform: scale(0.97); }
    .btn-primary-app { background-color: #3b82f6; color: white; box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4); font-size: 1.1rem; padding: 18px; }
    .btn-secondary-app { background-color: #f8f9fa; color: #374151; border: 1px solid #e9ecef; }
    .btn-danger-app { background-color: #fee2e2; color: #ef4444; border: 1px solid #fecaca; }
    .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    /* Modal CSS */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: flex-end; justify-content: center; }
    .modal-sheet { background: white; width: 100%; max-width: 480px; border-top-left-radius: 25px; border-top-right-radius: 25px; padding: 25px; animation: slideUp 0.3s ease-out; max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column; }
    @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-title { font-size: 1.4rem; font-weight: 800; color: #212529; }

    /* Visitor Grid */
    .visitor-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding-bottom: 20px; }
    .btn-num { background: #f8f9fa; border: 2px solid #e9ecef; padding: 15px 0; border-radius: 12px; font-weight: 700; color: #1f2937; cursor: pointer; text-align: center; }
    .btn-num.selected { background-color: #e0f2fe; border-color: #3b82f6; color: #0284c7; box-shadow: 0 0 0 2px #3b82f6; }
    
    .selection-actions { display: none; flex-direction: column; gap: 10px; margin-top: 10px; padding-top: 20px; border-top: 1px solid #eee; }
    .selection-info { text-align: center; font-size: 0.9rem; color: #6b7280; margin-bottom: 5px; }
    
    /* HTMX Indicator */
    .htmx-indicator { display:none; }
    .htmx-request .htmx-indicator { display:inline; }
</style>




<div class="mobile-app-container">
    
    <div class="app-header">
        <div class="queue-name">{{ queue.name|truncatechars:20 }}</div>
        <button onclick="openSettingsModal()" class="btn-settings-app shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.5 2a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM9.05 3a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0V3h9.05zM4.5 7a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM2.05 8a2.5 2.5 0 0 1 4.9 0H16v1H6.95a2.5 2.5 0 0 1-4.9 0H0V8h2.05zm9.45 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zm-2.45 1a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0v-1h9.05z"/></svg>
        </button>
    </div>

    <div id="htmx-controller"
         hx-get="{% url 'get_admin_updates' queue.slug %}"
         hx-trigger="queue_update from:body, load">
    </div>

    <div id="status-card-area" class="status-card">
        <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-white-50 small">Syncing Data...</p>
    </div>

    <div id="controls-area" class="controls-area text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

</div>

<div id="numberModal" class="modal-overlay">
    <div class="modal-sheet">
        <div class="modal-header border-bottom pb-3">
            <h5 class="modal-title m-0 fw-bold">Pilih Pelawat</h5>
            <button onclick="closeModals()" class="btn-close"></button>
        </div>
        
        <div class="px-2 pb-2">
            <input type="text" 
                   class="form-control bg-light border-0" 
                   placeholder="Cari nombor tiket..." 
                   onkeyup="filterVisitors(this.value)">
        </div>

        <div class="visitor-grid pt-3" id="visitor-list-grid">
            <div class="text-center w-100 text-muted">Loading list...</div>
        </div>

        <div id="selection-actions" class="selection-actions">
            <div class="selection-info">Selected: <strong id="selected-number-display">--</strong></div>
            <div class="d-flex gap-2 flex-column">
                <a href="#" id="btn-call-selected" class="btn-app btn-primary-app py-3">Call Visitor</a>
                <a href="#" id="btn-remove-selected" class="btn-app btn-danger-app py-3 fw-bold">Remove from queue</a>
            </div>
        </div>
    </div>
</div>

<div id="addModal" class="modal-overlay">
    <div class="modal-sheet">
        <div class="modal-header border-bottom pb-3">
            <h5 class="modal-title m-0 fw-bold">Tambah Manual</h5>
            <button onclick="closeModals()" class="btn-close"></button>
        </div>
        <form hx-post="{% url 'add_manual_visitor' queue.slug %}" hx-swap="none" onsubmit="closeModals()" class="py-3">
            {% csrf_token %}
            <div class="mb-3">
                <label class="form-label fw-bold">Nama Pelawat (Pilihan)</label>
                <input type="text" name="custom_name" class="form-control form-control-lg bg-light" 
                       placeholder="{{ queue.input_label|default:'Enter name' }}">
            </div>
            <button type="submit" class="btn btn-primary w-100 py-3 rounded-pill fw-bold">Masukkan Tiket</button>
        </form>
    </div>
</div>

<div id="settingsModal" class="modal-overlay">
    <div class="modal-sheet">
        <div class="modal-header border-bottom pb-3 mb-3">
            <h5 class="modal-title m-0 fw-bold">Settings</h5>
            <button type="button" onclick="closeModals()" class="btn-close"></button>
        </div>
        
        {% include 'queues/partials/settings_form.html' %}
        
    </div>
</div>
            
            <div class="py-2">
                <div class="mb-3">
                    <label class="form-label fw-bold small text-muted">QUEUE NAME</label>
                    <input type="text" name="name" class="form-control bg-light border-0" value="{{ queue.name }}">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold small text-muted">KIOSK LINK</label>
                    <div class="input-group">
                        <input type="text" class="form-control bg-light border-0" value="{{ request.scheme }}://{{ request.get_host }}/q/{{ queue.slug }}/join/" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('{{ request.scheme }}://{{ request.get_host }}/q/{{ queue.slug }}/join/')">Copy</button>
                    </div>
                </div>
                <div class="card bg-light border-0 mb-3">
                    <div class="card-body d-flex justify-content-between align-items-center py-3">
                        <span class="fw-bold text-dark">Allow Join</span>
                        <div class="form-check form-switch m-0">
                            <input class="form-check-input fs-5" type="checkbox" name="allow_join" {% if queue.allow_join %}checked{% endif %}>
                        </div>
                    </div>
                </div>
                <div class="mb-5"></div>
            </div>
        </form>
    </div>
</div>

<div id="removeModal" class="modal-overlay">
    <div class="modal-sheet text-center">
        <div class="py-4">
            <h3 class="fw-bold text-danger mb-3">Clear Queue?</h3>
            <p class="text-muted mb-4 px-3">This will remove <strong>ALL</strong> waiting visitors permanently.</p>
            <form action="{% url 'remove_visitors' queue.slug %}" method="POST" class="d-grid gap-2">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger btn-lg rounded-pill">Yes, Clear All</button>
                <button type="button" onclick="closeModals()" class="btn btn-light btn-lg rounded-pill">Cancel</button>
            </form>
        </div>
    </div>
</div>

<div id="confirmModal" class="modal-overlay">
    <div class="modal-sheet text-center">
         <div class="py-4">
            <h3 class="fw-bold mb-3">Return to Queue?</h3>
            <p class="text-muted mb-4">Send visitor <strong id="returnNum">000</strong> back to waiting list?</p>
            <div class="d-grid gap-2">
                <a id="confirmYesBtn" href="#" class="btn btn-primary btn-lg rounded-pill">Yes, Return</a>
                <button type="button" onclick="closeModals()" class="btn btn-light btn-lg rounded-pill">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- UI LOGIC ---
    function closeModals() {
        document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none');
        resetSelection();
    }
    function openNumberModal() { document.getElementById('numberModal').style.display = 'flex'; }
    function openAddModal() { document.getElementById('addModal').style.display = 'flex'; }
    function openSettingsModal() { document.getElementById('settingsModal').style.display = 'flex'; }
    function openRemoveModal() { closeModals(); document.getElementById('removeModal').style.display = 'flex'; }
    
    function showConfirmModal(id, num) {
        document.getElementById('returnNum').innerText = num;
        document.getElementById('confirmYesBtn').href = "/q/visitor/" + id + "/return/";
        document.getElementById('confirmModal').style.display = 'flex';
    }

    function selectVisitor(btnElement, id, number) {
        document.querySelectorAll('.btn-num').forEach(el => el.classList.remove('selected'));
        btnElement.classList.add('selected');
        document.getElementById('selection-actions').style.display = 'flex';
        document.getElementById('selected-number-display').innerText = number;
        document.getElementById('btn-call-selected').href = "/q/visitor/" + id + "/invite/";
        document.getElementById('btn-remove-selected').href = "/q/visitor/" + id + "/remove/";
    }

    function resetSelection() {
        document.querySelectorAll('.btn-num').forEach(el => el.classList.remove('selected'));
        document.getElementById('selection-actions').style.display = 'none';
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => { alert("Link copied!"); });
    }

    // Fungsi Filter Pelawat Manual (Tanpa Request Server)
    function filterVisitors(query) {
        const btns = document.querySelectorAll('.btn-num');
        const lowerQuery = query.toLowerCase();
        btns.forEach(btn => {
            const num = btn.innerText.toLowerCase();
            if(num.includes(lowerQuery)) {
                btn.style.display = 'block';
            } else {
                btn.style.display = 'none';
            }
        });
    }

    // --- WEBSOCKET ---
    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const queueSlug = "{{ queue.slug }}"; 
    const socket = new WebSocket(protocol + window.location.host + '/ws/queue/' + queueSlug + '/');

    socket.onmessage = function(e) {
        // Trigger HTMX refresh
        document.body.dispatchEvent(new Event('queue_update'));
    };

    socket.onclose = function(e) { 
        console.log("Socket putus. Reconnecting...");
        setTimeout(() => location.reload(), 3000); 
    };
</script>

{% endblock %}