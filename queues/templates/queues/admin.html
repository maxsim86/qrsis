{% extends 'base.html' %}
{% block content %}

<style>
    /* --- GLOBAL RESPONSIVE RESET --- */
    body { 
        background-color: #f3f4f6; 
        margin: 0; 
        padding: 0; 
        min-height: 100vh; 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
    }

    /* MAIN CONTAINER: Responsive Width */
    .admin-container { 
        width: 100%;
        max-width: 1000px; /* Limit width on big screens */
        margin: 0 auto; 
        min-height: 100vh; 
        background-color: #ffffff; 
        display: flex; 
        flex-direction: column; 
        padding: 20px; 
        box-sizing: border-box;
    }
    
    /* On larger screens, add some shadow and margin */
    @media (min-width: 768px) {
        .admin-container {
            margin: 40px auto;
            min-height: auto;
            border-radius: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.05);
            padding: 40px;
        }
    }

    /* HEADER */
    .app-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 30px; 
    }
    .queue-name { font-size: 1.25rem; font-weight: 800; color: #111827; }

    /* DASHBOARD LAYOUT (Grid for Desktop) */
    .dashboard-grid {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    @media (min-width: 768px) {
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Side by side on desktop */
            align-items: start;
            gap: 40px;
        }
    }

    /* STATUS CARD */
    .status-card { 
        background: linear-gradient(145deg, #1f2937, #111827); 
        color: white; 
        border-radius: 25px; 
        padding: 40px 20px; 
        text-align: center; 
        box-shadow: 0 15px 30px rgba(0,0,0,0.2); 
    }
    .status-label { font-size: 0.85rem; letter-spacing: 1.5px; opacity: 0.8; font-weight: 600; text-transform: uppercase; }
    .status-number { font-size: clamp(5rem, 10vw, 7rem); font-weight: 800; line-height: 1.1; margin: 15px 0; letter-spacing: -3px; }

    /* CONTROLS AREA */
    .controls-area { display: flex; flex-direction: column; gap: 15px; }
    .btn-app { 
        width: 100%; 
        padding: 18px; 
        border: none; 
        border-radius: 18px; 
        font-size: 1rem; 
        font-weight: 700; 
        cursor: pointer; 
        transition: transform 0.1s, box-shadow 0.2s; 
        text-decoration: none; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
    }
    .btn-app:active { transform: scale(0.98); }
    .btn-app:hover { filter: brightness(105%); }

    .btn-primary-app { background-color: #3b82f6; color: white; box-shadow: 0 8px 20px -5px rgba(59, 130, 246, 0.5); font-size: 1.1rem; }
    .btn-secondary-app { background-color: #f3f4f6; color: #1f2937; border: 1px solid #e5e7eb; }
    .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

    /* MODAL (Responsive) */
    .modal-overlay { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.6); 
        z-index: 1000; 
        display: none; 
        /* Mobile: Align bottom */
        align-items: flex-end; 
        justify-content: center;
        backdrop-filter: blur(5px);
    }
    
    .modal-sheet { 
        background: white; 
        width: 100%; 
        border-top-left-radius: 25px; 
        border-top-right-radius: 25px; 
        padding: 25px; 
        max-height: 85vh; 
        display: flex; 
        flex-direction: column; 
        animation: slideUp 0.3s ease-out; 
    }

    @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }
    @keyframes fadeInScale { from {opacity: 0; transform: scale(0.95);} to {opacity: 1; transform: scale(1);} }

    /* Desktop Modal: Center Card */
    @media (min-width: 640px) {
        .modal-overlay { align-items: center; }
        .modal-sheet {
            max-width: 500px;
            border-radius: 25px;
            animation: fadeInScale 0.2s ease-out;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
    }

    /* VISITOR LIST GRID (Responsive Columns) */
    .visitor-grid { 
        display: grid; 
        /* Auto fill columns based on available width */
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); 
        gap: 12px; 
        overflow-y: auto; 
        padding-bottom: 10px; 
    }
    .btn-num { 
        background: #fff; 
        border: 2px solid #e5e7eb; 
        border-radius: 12px; 
        padding: 15px 0; 
        font-weight: 700; 
        color: #374151; 
        font-size: 1rem; 
        cursor: pointer; 
        transition: all 0.2s;
    }
    .btn-num:hover { border-color: #3b82f6; color: #3b82f6; }
    .btn-num.selected { background-color: #eff6ff; border-color: #3b82f6; color: #2563eb; }

    /* Utility */
    .btn-settings-app { 
        width: 45px; height: 45px; 
        background-color: #f3f4f6; border: none; 
        border-radius: 12px; 
        display: flex; align-items: center; justify-content: center; 
        cursor: pointer; font-size: 1.2rem;
        transition: background 0.2s;
    }
    .btn-settings-app:hover { background-color: #e5e7eb; }
</style>

<div class="admin-container"> <div class="app-header">
        <div class="queue-name">{{ queue.name|truncatechars:20 }}</div>
        <div class="d-flex gap-2">
            <a href="{% url 'queue_stats' queue.slug %}" class="btn-settings-app text-decoration-none" style="background-color: #ecfdf5; color: #059669;">
                üìä
            </a>
            <button onclick="openSettingsModal()" class="btn-settings-app">
                ‚öôÔ∏è
            </button>
        </div>
    </div>

    <div id="htmx-controller"
         hx-get="{% url 'get_admin_updates' queue.slug %}"
         hx-trigger="queue_update from:body, load">
    </div>

    <div class="dashboard-grid">
        
        <div id="status-card-area" class="status-card">
            <div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div>
        </div>

        <div id="controls-area" class="controls-area">
            <div class="spinner-border text-primary mx-auto" role="status"></div>
        </div>

    </div> </div>



<div id="numberModal" class="modal-overlay">
    <div class="modal-sheet">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold m-0">Pilih Pelawat</h5>
            <button onclick="closeModals()" class="btn-close"></button>
        </div>

        <div class="d-flex gap-2 mb-3 overflow-auto" style="white-space: nowrap;">
            <button class="btn btn-sm btn-dark px-3 rounded-pill"
                    hx-get="{% url 'search_visitors' queue.slug %}?type=ALL"
                    hx-target="#visitor-list-container">
                Semua
            </button>
            <button class="btn btn-sm btn-primary px-3 rounded-pill"
                    hx-get="{% url 'search_visitors' queue.slug %}?type=A"
                    hx-target="#visitor-list-container">
                üìù A
            </button>
            <button class="btn btn-sm btn-success px-3 rounded-pill"
                    hx-get="{% url 'search_visitors' queue.slug %}?type=B"
                    hx-target="#visitor-list-container">
                üí∞ B
            </button>
            <button class="btn btn-sm btn-info text-white px-3 rounded-pill"
                    hx-get="{% url 'search_visitors' queue.slug %}?type=C"
                    hx-target="#visitor-list-container">
                ‚ùì C
            </button>
        </div>

        <input type="search" 
               class="form-control form-control-lg bg-light border-0 mb-3" 
               placeholder="Cari nombor..." 
               name="q"
               hx-get="{% url 'search_visitors' queue.slug %}"
               hx-trigger="keyup changed delay:500ms, queue_update from:body" 
               hx-target="#visitor-list-container">

        <div id="visitor-list-container" style="flex: 1; overflow-y: auto;">
             {% include 'queues/partials/visitor_list.html' %}
        </div>

        <div id="selection-actions" class="selection-actions">
            <div class="text-center text-muted small mb-1">Nombor Dipilih: <strong id="selected-number-display" class="text-primary">--</strong></div>
            <div class="d-grid gap-2">
                <button id="btn-call-selected" class="btn btn-primary rounded-pill py-2 fw-bold">Panggil Sekarang</button>
                
                <button id="btn-remove-selected" class="btn btn-outline-danger rounded-pill py-2">Padam dari Q</button>
            </div>
        </div>

    </div>
</div>

<div id="addModal" class="modal-overlay">
    <div class="modal-sheet">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold m-0">Tambah Manual</h5>
            <button onclick="closeModals()" class="btn-close"></button>
        </div>
        <form hx-post="{% url 'add_manual_visitor' queue.slug %}" hx-swap="none" onsubmit="closeModals()">
            {% csrf_token %}
            <div class="mb-3">
                <label class="fw-bold small text-muted">JENIS SERVIS</label>
                <select name="service_type" class="form-select form-select-lg bg-light border-0">
                    <option value="A" selected>üìù A - Pendaftaran</option>
                    <option value="B">üí∞ B - Pembayaran</option>
                    <option value="C">‚ùì C - Pertanyaan</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="fw-bold small text-muted">NAMA (PILIHAN)</label>
                <input type="text" name="custom_name" class="form-control form-control-lg bg-light border-0" placeholder="Contoh: Ali">
            </div>
            <button type="submit" class="btn btn-primary w-100 py-3 rounded-pill fw-bold">Cetak Tiket</button>
        </form>
    </div>
</div>

<div id="confirmModal" class="modal-overlay">
    <div class="modal-sheet text-center">
         <div class="py-4">
            <h3 class="fw-bold mb-3">Kembali ke Queue?</h3>
            <p class="text-muted">Hantar <strong id="returnNum" class="text-dark">---</strong> ke barisan belakang?</p>
            <div class="d-grid gap-2 mt-4">
                <a id="confirmYesBtn" href="#" class="btn btn-primary btn-lg rounded-pill">Ya, Kembalikan</a>
                <button onclick="closeModals()" class="btn btn-light btn-lg rounded-pill">Batal</button>
            </div>
        </div>
    </div>
</div>

<div id="removeModal" class="modal-overlay">
    <div class="modal-sheet text-center">
        <div class="py-4">
            <h3 class="fw-bold text-danger mb-3">Kosongkan Q?</h3>
            <p class="text-muted">Tindakan ini memadam <strong>SEMUA</strong> pelawat menunggu.</p>
            <form action="{% url 'remove_visitors' queue.slug %}" method="POST" class="d-grid gap-2 mt-4">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger btn-lg rounded-pill">Ya, Padam Semua</button>
                <button type="button" onclick="closeModals()" class="btn btn-light btn-lg rounded-pill">Batal</button>
            </form>
        </div>
    </div>
</div>

<div id="settingsModal" class="modal-overlay">
    <div class="modal-sheet">
         <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold m-0">Settings</h5>
            <button onclick="closeModals()" class="btn-close"></button>
        </div>
        {% include 'queues/partials/settings_form.html' %}
    </div>
</div>

<script>
    // --- UI HELPERS ---
    function closeModals() {
        document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none');
        resetSelection();
    }
    
    window.openNumberModal = () => document.getElementById('numberModal').style.display = 'flex';
    window.openAddModal = () => document.getElementById('addModal').style.display = 'flex';
    window.openSettingsModal = () => document.getElementById('settingsModal').style.display = 'flex';
    window.openRemoveModal = () => { closeModals(); document.getElementById('removeModal').style.display = 'flex'; }
    
    window.showConfirmModal = (id, num) => {
        document.getElementById('returnNum').innerText = num;
        document.getElementById('confirmYesBtn').href = "/q/visitor/" + id + "/return/";
        document.getElementById('confirmModal').style.display = 'flex';
    }

    // Logic Pilih Pelawat & Set HTMX Button
    window.selectVisitor = (btnElement, id, number) => {
        // Highlight button
        document.querySelectorAll('.btn-num').forEach(el => el.classList.remove('selected'));
        if(btnElement) btnElement.classList.add('selected');
        
        // Show actions
        const actionPanel = document.getElementById('selection-actions');
        if(actionPanel) actionPanel.style.display = 'flex';
        
        document.getElementById('selected-number-display').innerText = number;
        
        // --- Setup HTMX Buttons Dynamically ---
        let callBtn = document.getElementById('btn-call-selected');
        let removeBtn = document.getElementById('btn-remove-selected');

        if(callBtn) {
            callBtn.setAttribute('hx-get', `/q/visitor/${id}/invite/`);
            callBtn.setAttribute('hx-swap', 'none'); 
            htmx.process(callBtn);
        }

        if(removeBtn) {
            removeBtn.setAttribute('hx-get', `/q/visitor/${id}/remove/`);
            removeBtn.setAttribute('hx-swap', 'none');
            // Note: We use hx-swap='none' because the WebSocket update will trigger the list refresh
            // But if you want immediate feedback, the WebSocket 'queue_update' trigger on the search input handles it.
            htmx.process(removeBtn);
        }
    }

    function resetSelection() {
        // Buang highlight pada semua nombor
        document.querySelectorAll('.btn-num').forEach(el => el.classList.remove('selected'));
        var actionPanel = document.getElementById('selection-actions');
        if (actionPanel) {
            actionPanel.style.display = 'none';
        }
    }
    window.copyToClipboard = (text) => {
        navigator.clipboard.writeText(text).then(() => alert("Copied!"));
    }

    // --- WEBSOCKET ---
    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const socket = new WebSocket(protocol + window.location.host + '/ws/queue/{{ queue.slug }}/');

    socket.onmessage = function(e) {
        // Trigger global event untuk update semua HTMX elements (Search list & Dashboard)
        document.body.dispatchEvent(new Event('queue_update'));
    };
    
    socket.onclose = () => setTimeout(() => location.reload(), 3000);
</script>

{% endblock %}