{% extends 'base.html' %}
{% block content %}

<style>
    /* --- MOBILE APP CSS (Kekal Sama) --- */
    body { background-color: #f3f4f6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; min-height: 100vh; }
    .mobile-app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background-color: #ffffff; box-shadow: 0 0 30px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: space-between; padding: 20px; box-sizing: border-box; }
    .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .queue-name { font-size: 1.1rem; font-weight: 700; color: #1f2937; }
    
    /* Settings Button */
    .btn-settings-app { width: 48px; height: 48px; background-color: #e0f2fe; color: #0284c7; border: none; border-radius: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.1s; }
    .btn-settings-app:active { transform: scale(0.95); }

    /* Status Card */
    .status-card { background-color: #1f2937; color: white; border-radius: 25px; padding: 40px 20px; text-align: center; box-shadow: 0 15px 30px rgba(0,0,0,0.2); margin-bottom: auto; margin-top: 20px; }
    .status-label { text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1.5px; opacity: 0.7; font-weight: 600; }
    .status-number { font-size: 7rem; font-weight: 800; line-height: 1.1; margin: 10px 0; letter-spacing: -3px; }
    .status-sub { font-size: 1rem; color: #9ca3af; }
    .status-sub strong { color: #fff; }

    /* Controls */
    .controls-area { display: flex; flex-direction: column; gap: 12px; margin-top: 30px; margin-bottom: 20px; }
    .btn-app { width: 100%; padding: 16px; border: none; border-radius: 16px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: transform 0.1s; text-decoration: none; display: flex; justify-content: center; align-items: center; }
    .btn-app:active { transform: scale(0.97); }
    .btn-primary-app { background-color: #3b82f6; color: white; box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4); font-size: 1.1rem; padding: 18px; }
    .btn-secondary-app { background-color: #f8f9fa; color: #374151; border: 1px solid #e9ecef; }
    .btn-danger-app { background-color: #fee2e2; color: #ef4444; border: 1px solid #fecaca; }
    .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    /* --- MODAL CSS --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: flex-end; justify-content: center; }
    .modal-sheet { background: white; width: 100%; max-width: 480px; border-top-left-radius: 25px; border-top-right-radius: 25px; padding: 25px; animation: slideUp 0.3s ease-out; max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column; }
    @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-title { font-size: 1.4rem; font-weight: 800; color: #212529; }

    /* VISITOR GRID & SELECTION */
    .visitor-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding-bottom: 20px; }
    .btn-num { 
        background: #f8f9fa; border: 2px solid #e9ecef; padding: 15px 0; border-radius: 12px; 
        font-weight: 700; color: #1f2937; cursor: pointer; text-align: center;
    }
    /* State bila dipilih */
    .btn-num.selected { 
        background-color: #e0f2fe; border-color: #3b82f6; color: #0284c7; 
        box-shadow: 0 0 0 2px #3b82f6; 
    }

    /* ACTION BAR (Muncul bila pilih nombor) */
    .selection-actions {
        display: none; /* Hidden by default */
        flex-direction: column; gap: 10px;
        margin-top: 10px; padding-top: 20px; border-top: 1px solid #eee;
    }
    .selection-info { text-align: center; font-size: 0.9rem; color: #6b7280; margin-bottom: 5px; }
    .selection-info strong { color: #000; font-size: 1.1rem; }

</style>

<div class="mobile-app-container">
    
    <div class="app-header">
        <div class="queue-name">{{ queue.name|truncatechars:20 }}</div>
        <button onclick="openSettingsModal()" class="btn-settings-app shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.5 2a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM9.05 3a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0V3h9.05zM4.5 7a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM2.05 8a2.5 2.5 0 0 1 4.9 0H16v1H6.95a2.5 2.5 0 0 1-4.9 0H0V8h2.05zm9.45 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zm-2.45 1a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0v-1h9.05z"/></svg>
        </button>
    </div>

    <div class="status-card">
        <div class="status-label">Last called visitor</div>
        <div class="status-number" id="display-number">
            {% if current_serving %}
                {{ current_serving.number|stringformat:"03d" }}
            {% else %}
                --
            {% endif %}
        </div>
        <div class="status-sub">
            Waiting: <strong id="waiting-count-display">{{ waiting_count }}</strong>
        </div>
    </div>

    <div class="controls-area">
        {% if next_visitor %}
            <a href="{% url 'call_next' queue.slug %}" class="btn-app btn-primary-app" id="btn-call-next">
                Call Next Visitor
            </a>
        {% else %}
            <a href="#" class="btn-app btn-primary-app disabled" id="btn-call-next" style="background-color: #d1d5db; box-shadow: none; pointer-events: none;">
                No Visitors
            </a>
        {% endif %}

        <div class="action-grid">
            <button onclick="openNumberModal()" class="btn-app btn-secondary-app">List</button>
            <button onclick="openAddModal()" class="btn-app btn-secondary-app">+ Add</button>
        </div>
        
        {% if current_serving %}
        <button onclick="showConfirmModal('{{ current_serving.id }}', '{{ current_serving.number|stringformat:'03d' }}')" class="btn-app btn-secondary-app text-danger border-danger">
            Return to Queue
        </button>
        {% endif %}
        
        <div class="text-center mt-2">
            <button onclick="openRemoveModal()" style="background:none; border:none; color:#9ca3af; font-size:0.85rem; cursor:pointer;">
                Clear entire queue
            </button>
        </div>
    </div>

</div>

<div id="numberModal" class="modal-overlay">
    <div class="modal-sheet">
        <div class="modal-header border-bottom pb-3">
            <h5 class="modal-title m-0 fw-bold">Choose Visitor</h5>
            <button onclick="closeModals()" class="btn-close"></button>
        </div>
        
        <div class="visitor-grid pt-3" id="visitor-list-grid">
            {% for v in all_waiting_visitors %}
                <button onclick="selectVisitor(this, '{{ v.id }}', '{{ v.number|stringformat:"03d" }}')" class="btn-num">
                    {{ v.number|stringformat:"03d" }}
                </button>
            {% empty %}
                <div class="text-center text-muted w-100 py-4" style="grid-column: span 4;">
                    Queue is empty
                </div>
            {% endfor %}
        </div>

        <div id="selection-actions" class="selection-actions">
            <div class="selection-info">
                Selected: <strong id="selected-number-display">--</strong>
            </div>
            
            <div class="d-flex gap-2 flex-column">
                <a href="#" id="btn-call-selected" class="btn-app btn-primary-app py-3">
                    Call Visitor
                </a>
                
                <a href="#" id="btn-remove-selected" class="btn-app btn-danger-app py-3 fw-bold">
                    Remove from queue
                </a>
            </div>
        </div>

    </div>
</div>

<div id="addModal" class="modal-overlay">
    <div class="modal-sheet">
        <div class="modal-header border-bottom pb-3">
            <h5 class="modal-title m-0 fw-bold">Add Manual</h5>
            <button onclick="closeModals()" class="btn-close"></button>
        </div>
        <form action="{% url 'add_manual_visitor' queue.slug %}" method="POST" class="py-3">
            {% csrf_token %}
            <div class="mb-3">
                <label class="form-label fw-bold">Visitor Name (Optional)</label>
                <input type="text" name="custom_name" class="form-control form-control-lg bg-light" 
                       placeholder="{{ queue.input_label|default:'Enter name' }}">
            </div>
            <button type="submit" class="btn btn-primary w-100 py-3 rounded-pill fw-bold">Add Ticket</button>
        </form>
    </div>
</div>

<div id="settingsModal" class="modal-overlay">
    <div class="modal-sheet">
        <form action="{% url 'update_queue_settings' queue.slug %}" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="modal-header border-bottom pb-3 mb-3">
                <h5 class="modal-title m-0 fw-bold">Settings</h5>
                <button type="submit" class="btn btn-sm btn-primary rounded-pill px-3">Save</button>
            </div>

            <div class="py-2">
                <div class="mb-3">
                    <label class="form-label fw-bold small text-muted">QUEUE NAME</label>
                    <input type="text" name="name" class="form-control bg-light border-0" value="{{ queue.name }}">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold small text-muted">KIOSK LINK</label>
                    <div class="input-group">
                        <input type="text" class="form-control bg-light border-0" value="{{ request.scheme }}://{{ request.get_host }}/q/{{ queue.slug }}/join/" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('{{ request.scheme }}://{{ request.get_host }}/q/{{ queue.slug }}/join/')">Copy</button>
                    </div>
                </div>
                <div class="card bg-light border-0 mb-3">
                    <div class="card-body d-flex justify-content-between align-items-center py-3">
                        <span class="fw-bold text-dark">Allow Join</span>
                        <div class="form-check form-switch m-0">
                            <input class="form-check-input fs-5" type="checkbox" name="allow_join" {% if queue.allow_join %}checked{% endif %}>
                        </div>
                    </div>
                </div>
                <div class="card bg-light border-0 mb-3">
                    <div class="card-body d-flex justify-content-between align-items-center py-3">
                        <span class="fw-bold text-dark">Ask Visitor Name</span>
                        <div class="form-check form-switch m-0">
                            <input class="form-check-input fs-5" type="checkbox" id="askInputToggle" name="ask_input" {% if queue.ask_input %}checked{% endif %} onchange="toggleInputPrompt()">
                        </div>
                    </div>
                </div>
                <div id="inputPromptContainer" class="mb-3 ps-2" style="display: {% if queue.ask_input %}block{% else %}none{% endif %};">
                    <input type="text" name="input_label" class="form-control" value="{{ queue.input_label|default:'Enter your name' }}">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold small text-muted">LOGO</label>
                    <input type="file" name="logo" class="form-control">
                </div>
                <div class="mb-5"></div>
            </div>
        </form>
    </div>
</div>

<div id="removeModal" class="modal-overlay">
    <div class="modal-sheet text-center">
        <div class="py-4">
            <h3 class="fw-bold text-danger mb-3">Clear Queue?</h3>
            <p class="text-muted mb-4 px-3">This will remove <strong>ALL</strong> waiting visitors permanently.</p>
            <form action="{% url 'remove_visitors' queue.slug %}" method="POST" class="d-grid gap-2">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger btn-lg rounded-pill">Yes, Clear All</button>
                <button type="button" onclick="closeModals()" class="btn btn-light btn-lg rounded-pill">Cancel</button>
            </form>
        </div>
    </div>
</div>

<div id="confirmModal" class="modal-overlay">
    <div class="modal-sheet text-center">
         <div class="py-4">
            <h3 class="fw-bold mb-3">Return to Queue?</h3>
            <p class="text-muted mb-4">Send visitor <strong id="returnNum">000</strong> back to waiting list?</p>
            <div class="d-grid gap-2">
                <a id="confirmYesBtn" href="#" class="btn btn-primary btn-lg rounded-pill">Yes, Return</a>
                <button type="button" onclick="closeModals()" class="btn btn-light btn-lg rounded-pill">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- UI LOGIC ---
    function closeModals() {
        document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none');
        // Reset selection bila modal tutup
        resetSelection();
    }
    function openNumberModal() { document.getElementById('numberModal').style.display = 'flex'; }
    function openAddModal() { document.getElementById('addModal').style.display = 'flex'; }
    function openSettingsModal() { 
        document.getElementById('settingsModal').style.display = 'flex'; 
        toggleInputPrompt();
    }
    function openRemoveModal() { 
        closeModals(); 
        document.getElementById('removeModal').style.display = 'flex'; 
    }
    
    function showConfirmModal(id, num) {
        document.getElementById('returnNum').innerText = num;
        document.getElementById('confirmYesBtn').href = "/visitor/" + id + "/return/";
        document.getElementById('confirmModal').style.display = 'flex';
    }

    // --- LOGIK PEMILIHAN NOMBOR (PENTING) ---
    function selectVisitor(btnElement, id, number) {
        // 1. Buang class 'selected' dari semua butang
        document.querySelectorAll('.btn-num').forEach(el => el.classList.remove('selected'));
        
        // 2. Tambah class 'selected' ke butang yang ditekan
        btnElement.classList.add('selected');
        
        // 3. Tunjuk panel action di bawah
        const actionPanel = document.getElementById('selection-actions');
        actionPanel.style.display = 'flex';
        
        // 4. Update info dan link butang
        document.getElementById('selected-number-display').innerText = number;
        
        // Set Link untuk CALL
        document.getElementById('btn-call-selected').href = "/visitor/" + id + "/invite/";
        
        // Set Link untuk REMOVE
        document.getElementById('btn-remove-selected').href = "/visitor/" + id + "/remove/";
    }

    function resetSelection() {
        document.querySelectorAll('.btn-num').forEach(el => el.classList.remove('selected'));
        document.getElementById('selection-actions').style.display = 'none';
    }

    function toggleInputPrompt() {
        const toggle = document.getElementById('askInputToggle');
        const container = document.getElementById('inputPromptContainer');
        if(toggle && container) container.style.display = toggle.checked ? 'block' : 'none';
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => { alert("Link copied!"); });
    }

    // --- WEBSOCKET ---
    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const queueSlug = "{{ queue.slug }}"; 
    const socket = new WebSocket(protocol + window.location.host + '/ws/queue/' + queueSlug + '/');

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const eventType = data.message;
        const payload = data.data;

        if (payload.waiting_count !== undefined) {
            document.getElementById('waiting-count-display').innerText = payload.waiting_count;
            const btnNext = document.getElementById('btn-call-next');
            if (payload.waiting_count > 0) {
                btnNext.classList.remove('disabled');
                btnNext.style.backgroundColor = ""; btnNext.style.boxShadow = ""; btnNext.style.pointerEvents = "auto";
                btnNext.innerText = "Call Next Visitor";
                btnNext.href = "{% url 'call_next' queue.slug %}";
            } else {
                btnNext.classList.add('disabled');
                btnNext.style.backgroundColor = "#d1d5db"; btnNext.style.boxShadow = "none"; btnNext.style.pointerEvents = "none";
                btnNext.innerText = "No Visitors";
                btnNext.removeAttribute('href');
            }
        }

        if (eventType === 'invite_next') {
            document.getElementById('display-number').innerText = payload.number;
            setTimeout(() => location.reload(), 500);
        }

        if (eventType === 'new_visitor') {
            const grid = document.getElementById('visitor-list-grid');
            if(grid.innerText.includes("Queue is empty")) grid.innerHTML = "";
            
            // Create button element dynamically
            const btn = document.createElement('button');
            btn.className = "btn-num";
            btn.innerText = payload.number;
            btn.onclick = function() { selectVisitor(this, payload.visitor_id, payload.number) };
            
            grid.appendChild(btn);
        }
        
        // Refresh jika ada remove/reset
        if (eventType === 'queue_reset' || eventType === 'visitor_quit' || eventType === 'return_queue') {
            location.reload();
        }
    };
</script>

{% endblock %}