{% extends 'base.html' %}
{% block content %}

<style>
    /* CSS Global */
    body { background-color: #ffffff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    .top-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; margin-bottom: 40px; color: #6c757d; font-size: 0.9rem; }
    .upgrade-link { color: #3b82f6; text-decoration: none; font-weight: 500; margin-right: 15px; }
    
    /* Serving Card */
    .serving-card { background-color: #f8f9fa; border-radius: 20px; padding: 40px 20px; text-align: center; max-width: 400px; margin: 0 auto 50px auto; }
    .serving-title { font-weight: 700; font-size: 1rem; margin-bottom: 10px; color: #000; }
    .serving-number { font-size: 5rem; font-weight: 800; line-height: 1; color: #000; letter-spacing: -2px; }
    .serving-name { color: #6c757d; font-size: 1.1rem; margin-bottom: 20px; }
    
    /* Buttons */
    .btn-return { background-color: #e9ecef; color: #000; border: none; border-radius: 8px; padding: 8px 20px; font-size: 0.9rem; font-weight: 500; text-decoration: none; display: inline-block; }
    .btn-return:hover { background-color: #dee2e6; color: black; }
    .action-buttons { max-width: 400px; margin: 0 auto; display: flex; flex-direction: column; gap: 12px; }
    .btn-invite-next { background-color: #93c5fd; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; width: 100%; }
    .btn-invite-next:hover { background-color: #60a5fa; }
    .btn-invite-next:disabled { background-color: #e5e7eb; cursor: not-allowed; }
    .btn-invite-num { background-color: #f8f9fa; color: #93c5fd; border: none; padding: 12px; border-radius: 8px; font-weight: 500; width: 100%; }
    .btn-add-outline { background-color: white; color: #2563eb; border: 1px solid #2563eb; padding: 12px; border-radius: 8px; font-weight: 500; width: 100%; }
    .btn-remove-outline { background-color: white; color: #ef4444; border: 1px solid #fca5a5; padding: 12px; border-radius: 8px; font-weight: 400; width: 100%; }
    .alert-msg { position: fixed; top: 20px; right: 20px; z-index: 10000; }
    
    /* Modal CSS */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); z-index: 9999; display: flex; justify-content: center; align-items: center; }
    .modal-card { background-color: white; width: 90%; max-width: 400px; border-radius: 15px; padding: 30px; text-align: center; position: relative; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); }
    .close-btn { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; color: #ccc; cursor: pointer; }
    .fade-in { animation: fadeInScale 0.2s ease-out forwards; }
    @keyframes fadeInScale { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    
    /* Style Khas untuk Pill Nombor */
    .btn-number-pill { background-color: #f3f4f6; border: none; border-radius: 50px; padding: 10px 25px; font-size: 1.5rem; font-weight: 700; color: #000; min-width: 100px; }
    .btn-number-pill:hover { background-color: #e5e7eb; }
    .btn-number-pill.selected { background-color: #3b82f6; color: white; }
</style>

<div class="container" style="max-width: 800px;">
    <div id="notification-area">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-success alert-dismissible fade show text-center mb-4" role="alert">
                    <strong>Success!</strong> {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    </div>

    <div class="top-header">
        <span class="text-muted">{{ queue.name }}</span>
        <div><a href="#" class="upgrade-link">Upgrade to QRQ+</a></div>
    </div>

    <div class="text-center mb-4 text-muted">
        <span id="waiting-count-display">
            {% if waiting_count > 0 %}{{ waiting_count }}{% else %}0{% endif %}
        </span> 
        people waiting in queue
    </div>

    <div class="serving-card">
        <div class="serving-title">Currently serving</div>
        <div id="current-serving-block">
            {% if current_serving %}
                <div class="serving-number" id="admin-serving-num">{{ current_serving.number|stringformat:"03d" }}</div>
                <div class="serving-name" id="admin-serving-name">"{{ current_serving.name }}"</div>
                <button id="btn-return-queue" onclick="showConfirmModal('{{ current_serving.id }}', '{{ current_serving.number|stringformat:'03d' }}')" class="btn-return" style="cursor: pointer;">
                    Return to queue
                </button>
            {% else %}
                <div class="serving-number" id="admin-serving-num" style="color: #000;">000</div>
                <div class="serving-name" id="admin-serving-name" class="text-muted">Waiting to serve</div>
                <button id="btn-return-queue" class="btn-return" style="display: none;">Return to queue</button>
            {% endif %}
        </div>
    </div>

    <div class="action-buttons">
        <div id="invite-btn-container">
            {% if next_visitor %}
                <button onclick="showInviteModal('{{ next_visitor.number|stringformat:'03d' }}')" class="btn btn-invite-next text-center w-100 mb-2">Invite next</button>
            {% else %}
                <button class="btn btn-invite-next text-center w-100 mb-2" disabled style="opacity: 0.6; cursor: not-allowed;">Invite next</button>
            {% endif %}
        </div>
        <button onclick="showNumberModal()" class="btn btn-invite-num w-100">Invite by number</button>
        <button onclick="showAddModal('{{ next_new_number|stringformat:'03d' }}')" class="btn btn-add-outline text-center w-100">Add</button>
        <form action="{% url 'remove_visitors' queue.slug %}" method="POST" onsubmit="return confirm('Are you sure you want to remove ALL visitors?');">
            {% csrf_token %}
            <button type="submit" class="btn btn-remove-outline">Remove visitors</button>
        </form>
    </div>
    <div class="footer-link"><a href="#">Report a problem</a></div>
</div>

<div id="confirmModal" class="modal-overlay" style="display: none;">
    <div class="modal-card fade-in">
        <span onclick="closeConfirmModal()" class="close-btn">&times;</span>
        <h3 class="fw-bold mb-2">Are you sure?</h3>
        <p class="text-muted mb-4">The visitor with number <strong id="modalVisitorNum">000</strong> will be appended back to queue.</p>
        <a id="confirmYesBtn" href="#" class="btn btn-primary w-100 py-2 rounded-3 fw-bold mb-2">Yes</a>
        <button onclick="closeConfirmModal()" class="btn btn-light w-100 py-2 rounded-3 fw-bold text-muted border">No</button>
    </div>
</div>

<div id="inviteModal" class="modal-overlay" style="display: none;">
    <div class="modal-card fade-in">
        <span onclick="closeInviteModal()" class="close-btn">&times;</span>
        <h3 class="fw-bold mb-2">Are you sure?</h3>
        <p class="text-muted mb-4">Next visitor number is <strong id="inviteNum">000</strong>. Do you want to invite next visitor?</p>
        <a href="{% url 'call_next' queue.slug %}" class="btn btn-primary w-100 py-2 rounded-3 fw-bold mb-2">Yes</a>
        <button onclick="closeInviteModal()" class="btn btn-light w-100 py-2 rounded-3 fw-bold text-muted border">No</button>
    </div>
</div>

<div id="addModal" class="modal-overlay" style="display: none;">
    <div class="modal-card fade-in">
        <span onclick="closeAddModal()" class="close-btn">&times;</span>
        <h3 class="fw-bold mb-2">Add Visitor?</h3>
        <p class="text-muted mb-4">Are you sure you want to add a new visitor manually?<br>Next number will be <strong id="addNum">000</strong>.</p>
        <a href="{% url 'add_manual_visitor' queue.slug %}" class="btn btn-primary w-100 py-2 rounded-3 fw-bold mb-2">Yes</a>
        <button onclick="closeAddModal()" class="btn btn-light w-100 py-2 rounded-3 fw-bold text-muted border">No</button>
    </div>
</div>

<div id="numberModal" class="modal-overlay" style="display: none;">
    <div class="modal-card fade-in" style="max-width: 500px;">
        <span onclick="closeNumberModal()" class="close-btn">&times;</span>
        <h4 class="fw-bold mb-4">Choose visitor</h4>
        <div class="d-flex flex-wrap justify-content-center gap-2 mb-4" style="max-height: 300px; overflow-y: auto;">
            {% for v in all_waiting_visitors %}
                <button onclick="selectVisitor(this, '{{ v.id }}')" class="btn btn-number-pill">
                    {{ v.number|stringformat:"03d" }}
                </button>
            {% empty %}
                <p class="text-muted">No visitors in queue.</p>
            {% endfor %}
        </div>
        <div class="d-flex justify-content-between align-items-center">
            <a href="#" id="inviteLink" class="text-primary text-decoration-none fw-bold" style="visibility: hidden;">Invite</a>
            <button onclick="closeNumberModal()" class="btn btn-light rounded-3 fw-bold text-muted border px-4">Close</button>
        </div>
    </div>
</div>

<script>
    // --- Modal Logic ---
    function showConfirmModal(visitorId, visitorNumber) {
        document.getElementById('modalVisitorNum').innerText = visitorNumber;
        document.getElementById('confirmYesBtn').href = "/visitor/" + visitorId + "/return/";
        document.getElementById('confirmModal').style.display = 'flex';
    }
    function closeConfirmModal() { document.getElementById('confirmModal').style.display = 'none'; }

    function showInviteModal(nextNumber) {
        document.getElementById('inviteNum').innerText = nextNumber;
        document.getElementById('inviteModal').style.display = 'flex';
    }
    function closeInviteModal() { document.getElementById('inviteModal').style.display = 'none'; }

    function showAddModal(nextNewNumber) {
        document.getElementById('addNum').innerText = nextNewNumber;
        document.getElementById('addModal').style.display = 'flex';
    }
    function closeAddModal() { document.getElementById('addModal').style.display = 'none'; }
    
    // Choose Visitor Modal
    function showNumberModal() { document.getElementById('numberModal').style.display = 'flex'; }
    function closeNumberModal() { 
        document.getElementById('numberModal').style.display = 'none';
        document.querySelectorAll('.btn-number-pill').forEach(el => el.classList.remove('selected'));
        document.getElementById('inviteLink').style.visibility = 'hidden';
    }
    function selectVisitor(btnElement, visitorId) {
        document.querySelectorAll('.btn-number-pill').forEach(el => el.classList.remove('selected'));
        btnElement.classList.add('selected');
        const inviteLink = document.getElementById('inviteLink');
        inviteLink.href = "/visitor/" + visitorId + "/invite/";
        inviteLink.style.visibility = 'visible';
        inviteLink.innerText = "Invite Visitor";
    }

    // Close Modals on click outside
    window.onclick = function(event) {
        if (event.target == document.getElementById('inviteModal')) closeInviteModal();
        if (event.target == document.getElementById('confirmModal')) closeConfirmModal();
        if (event.target == document.getElementById('addModal')) closeAddModal();
        if (event.target == document.getElementById('numberModal')) closeNumberModal();
    }

    // --- WEBSOCKET SETUP ---
    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const queueSlug = "{{ queue.slug }}"; 
    const socket = new WebSocket(protocol + window.location.host + '/ws/queue/' + queueSlug + '/');

    socket.onopen = function(e) { console.log("Admin Connected"); };

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const eventType = data.message;
        const payload = data.data;

        console.log("Admin Event:", eventType);

        if (eventType === 'new_visitor') {
            updateWaitingCount(1);
        } 
        else if (eventType === 'visitor_quit') {
            updateWaitingCount(-1);
        }
        else if (eventType === 'invite_next' || eventType === 'queue_reset') {
            location.reload();
        }
        // PEMBETULAN: Logik ini MESTI di dalam function socket.onmessage
        else if (eventType === 'return_queue') {
            // 1. Update Nombor Admin jadi 000
            document.getElementById('admin-serving-num').innerText = "000";
            document.getElementById('admin-serving-name').innerText = "Waiting to serve";
            
            // 2. Sorokkan butang Return
            const btnReturn = document.getElementById('btn-return-queue');
            if(btnReturn) btnReturn.style.display = 'none';

            // 3. Update Waiting Count
            if (payload.waiting_count !== undefined) {
                document.getElementById('waiting-count-display').innerText = payload.waiting_count;
            }
        }
    };

    function updateWaitingCount(amount) {
        const countSpan = document.getElementById('waiting-count-display');
        let currentCount = parseInt(countSpan.innerText);
        let newCount = currentCount + amount;
        if (newCount < 0) newCount = 0;
        countSpan.innerText = newCount;
        
        const btnContainer = document.getElementById('invite-btn-container');
        if (newCount > 0 && btnContainer.querySelector('button').disabled) {
             location.reload(); 
        }
    }
</script>

{% endblock %}