{% extends 'base.html' %}
{% block content %}

<style>
    /* --- GLOBAL & RESET --- */
    body { 
        background-color: #ffffff; 
        margin: 0; 
        padding: 0; 
        overflow: hidden; 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    /* Bekas Utama: Penuhkan Skrin */
    .display-container { 
        height: 100vh; 
        width: 100vw;
        display: flex; 
        flex-direction: column; 
        justify-content: space-between; 
        align-items: center; 
        padding: 4vh 0; 
        box-sizing: border-box;
    }

    /* --- BAHAGIAN ATAS (HEADER) --- */
    .queue-header {
        width: 90%;
        display: flex;
        justify-content: flex-start;
        align-items: center;
        border-bottom: 2px solid #f3f4f6;
        padding-bottom: 20px;
    }

    .queue-logo-img {
        height: 120px; 
        width: auto;   
        margin-right: 30px; 
        object-fit: contain; 
    }

    .queue-title { 
        font-size: 2.5rem; 
        font-weight: 700; 
        color: #111827; 
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .queue-badge {
        background-color: #3b82f6;
        color: white;
        padding: 5px 15px;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        margin-right: 15px;
        text-transform: uppercase;
    }

    /* --- BAHAGIAN TENGAH --- */
    .active-section {
        flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    .label-current { font-size: 2rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 2px; margin-bottom: -10px; }
    .big-number { font-size: 22rem; font-weight: 900; line-height: 1; color: #000; letter-spacing: -10px; font-variant-numeric: tabular-nums; transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), color 0.2s; }
    .pop-in { transform: scale(1.1); color: #3b82f6; }
    .visitor-name { font-size: 3rem; color: #3b82f6; font-weight: 700; margin-top: 10px; max-width: 90vw; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .counter-display { font-size: 4rem; color: #ef4444; font-weight: 800; margin-top: 20px; text-transform: uppercase; }

    /* --- BAHAGIAN BAWAH --- */
    .footer-section { width: 100%; display: flex; flex-direction: column; align-items: center; background: linear-gradient(to top, #ffffff 80%, rgba(255,255,255,0)); padding-bottom: 2vh; }
    .next-label { font-size: 1.5rem; font-weight: 700; color: #374151; margin-bottom: 15px; text-transform: uppercase; }
    .next-list { display: flex; gap: 30px; justify-content: center; margin-bottom: 30px; }
    .next-card { background-color: #f3f4f6; padding: 15px 40px; border-radius: 20px; min-width: 120px; text-align: center; }
    .next-number { font-size: 4rem; font-weight: 800; color: #1f2937; line-height: 1; }
    .waiting-info { font-size: 1.5rem; color: #9ca3af; font-weight: 500; border-top: 1px solid #f3f4f6; padding-top: 15px; width: 60%; text-align: center; }
    .waiting-info strong { color: #000; }
</style>

<div class="display-container">
    
    <div class="queue-header">
        {% if queue.logo %}
            <img src="{{ queue.logo.url }}" class="queue-logo-img" alt="Queue Logo">
        {% else %}
            <span class="queue-badge">Counter</span>
        {% endif %}
        
        <div class="queue-title">{{ queue.name }}</div>
    </div>    
    <div id="active-container" class="active-section">
        <div class="label-current">Now Serving</div>
        <div id="number-text" class="big-number">000</div>
        <div id="counter-text" class="counter-display"></div>
        <div id="name-text" class="visitor-name"></div>
    </div>

    <div class="footer-section">
        <div class="next-label">Coming Up Next</div>
        <div id="next-list-container" class="next-list">
            <div class="next-card"><span class="next-number">-</span></div>
            <div class="next-card"><span class="next-number">-</span></div>
            <div class="next-card"><span class="next-number">-</span></div>
        </div>
        <div class="waiting-info">
            Total waiting: <strong id="total-waiting">0</strong> visitors
        </div>
    </div>

</div> 
<audio id="notify-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<script>
    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const queueSlug = "{{ queue.slug }}"; 
    const socket = new WebSocket(protocol + window.location.host + '/ws/queue/' + queueSlug + '/');

    function playAudio() {
        const audio = document.getElementById('notify-sound');
        if(audio) {
            audio.currentTime = 0;
            audio.play().catch(e => console.log("Audio play failed:", e));
        }
    }

    function playAnnouncement(ticket, counter) {
        const chime = document.getElementById('notify-sound');
        if(chime) { chime.currentTime = 0; chime.play(); }
        
        setTimeout(() => {
            let msg = new SpeechSynthesisUtterance(`Number ${ticket}, please proceed to ${counter}`);
            msg.lang = 'en-US'; 
            window.speechSynthesis.speak(msg);
        }, 1000);
    }

    function updateNextList(visitorsArray) {
        const container = document.getElementById('next-list-container');
        container.innerHTML = ""; 
        if (!visitorsArray || visitorsArray.length === 0) {
            container.innerHTML = `<div class="next-card"><span class="next-number" style="color:#ccc">-</span></div><div class="next-card"><span class="next-number" style="color:#ccc">-</span></div><div class="next-card"><span class="next-number" style="color:#ccc">-</span></div>`;
            return;
        }
        visitorsArray.forEach(num => {
            const card = document.createElement('div'); card.className = 'next-card';
            const span = document.createElement('span'); span.className = 'next-number'; span.innerText = num;
            card.appendChild(span); container.appendChild(card);
        });
    }

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const eventType = data.message;
        const payload = data.data;

        if (eventType === 'invite_next') {
            const numEl = document.getElementById('number-text');
            const nameEl = document.getElementById('name-text');
            const counterEl = document.getElementById('counter-text');

            numEl.innerText = payload.ticket || payload.number; 
            nameEl.innerText = `"${payload.name}"`;
            
            if (payload.counter) {
                counterEl.innerText = `PLEASE GO TO ${payload.counter.toUpperCase()}`;
            } else {
                counterEl.innerText = "PLEASE PROCEED";
            }

            numEl.classList.add('pop-in');
            setTimeout(() => numEl.classList.remove('pop-in'), 300);
            playAnnouncement(payload.ticket || payload.number, payload.counter);
        }

        if (eventType === 'return_queue') {
            document.getElementById('number-text').innerText = "000"; 
            document.getElementById('name-text').innerText = "";
            document.getElementById('counter-text').innerText = "";
        }

        if (eventType === 'queue_reset') {
            document.getElementById('number-text').innerText = "000";
            document.getElementById('name-text').innerText = ""; 
            document.getElementById('counter-text').innerText = "";
            document.getElementById('total-waiting').innerText = "0";
            updateNextList([]);
        }
        
        if (payload.next_visitors) updateNextList(payload.next_visitors);
        if (payload.waiting_count !== undefined) document.getElementById('total-waiting').innerText = payload.waiting_count;
    };

    socket.onclose = function(e) { 
        console.log("Socket closed. Reloading in 3s...");
        setTimeout(function() { location.reload(); }, 3000); 
    };
</script>
{% endblock %}