{% extends 'base.html' %}
{% block content %}

<style>
    /* RESET & LAYOUT */
    html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #ffffff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    .display-container { height: 100vh; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; }
    
    /* HEADER */
    .queue-header { height: 12vh; display: flex; justify-content: center; align-items: center; border-bottom: 1px solid #e5e7eb; gap: 20px; }
    .queue-logo-img { height: 60%; width: auto; object-fit: contain; }
    .queue-title { font-size: clamp(1.5rem, 4vw, 2.5rem); font-weight: 800; color: #1f2937; text-transform: uppercase; }

    /* MAIN CONTENT */
    .active-section { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
    .label-current { font-size: clamp(1.2rem, 3vh, 2.2rem); font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 4px; }
    
    /* NOMBOR BESAR */
    .big-number { 
        font-size: clamp(10rem, 35vh, 25rem); 
        font-weight: 900; line-height: 1; color: #2563eb; 
        letter-spacing: -5px; transition: transform 0.3s ease-out; margin: 10px 0; 
        font-variant-numeric: tabular-nums; 
    }
    
    .visitor-name { font-size: clamp(1.5rem, 5vh, 3.5rem); color: #1f2937; font-weight: 700; margin-top: 1vh; }
    
    .counter-display { 
        font-size: clamp(1.5rem, 4vh, 3.5rem); color: #ef4444; font-weight: 800;
        margin-top: 3vh; text-transform: uppercase; background: #fef2f2;
        padding: 15px 50px; border-radius: 50px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    
    /* ANIMASI */
    .pop-in { animation: popScale 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes popScale { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

    /* FOOTER */
    .footer-section { height: 25vh; background: #f9fafb; border-top: 1px solid #e5e7eb; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
    .next-label { font-size: clamp(0.9rem, 2vh, 1.2rem); font-weight: 700; color: #9ca3af; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 2px; }
    .next-list { display: flex; gap: 3vw; justify-content: center; width: 100%; }
    .next-card { background-color: #ffffff; padding: 1.5vh 3vw; border-radius: 20px; min-width: 120px; text-align: center; box-shadow: 0 5px 10px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; }
    .next-number { font-size: clamp(2.5rem, 6vh, 4rem); font-weight: 800; color: #374151; line-height: 1; }
    .waiting-info { position: absolute; bottom: 20px; right: 30px; font-size: 1rem; color: #9ca3af; }
</style>

<div class="display-container">
    
    <div class="queue-header">
        {% if queue.logo %}
            <img src="{{ queue.logo.url }}" class="queue-logo-img" alt="Logo">
        {% endif %}
        <div class="queue-title">{{ queue.name }}</div>
    </div>    

    <div id="active-container" class="active-section">
        <div class="label-current">Sedang Berkhidmat</div>
        
        <div id="number-text" class="big-number">
            {% if current_serving %}
                {{ current_serving.ticket_number }} 
            {% else %}
                ---
            {% endif %}
        </div>
        
        <div id="name-text" class="visitor-name">
            {{ current_serving.name|default:"" }}
        </div>
        
        <div id="counter-text" class="counter-display" style="{% if not current_serving %}display: none;{% endif %}">
            {{ current_serving.served_by|default:"KAUNTER" }}
        </div>
    </div>

    <div class="footer-section">
        <div class="next-label">Akan Datang</div>
        <div id="next-list-container" class="next-list">
            {% if next_visitors %}
                {% for ticket in next_visitors %}
                    <div class="next-card"><span class="next-number">{{ ticket }}</span></div>
                {% endfor %}
            {% else %}
                <div class="next-card"><span class="next-number">-</span></div>
                <div class="next-card"><span class="next-number">-</span></div>
                <div class="next-card"><span class="next-number">-</span></div>
            {% endif %}
        </div>
        <div class="waiting-info">
            Menunggu: <strong id="total-waiting" style="color:#000">{{ waiting_count|default:"0" }}</strong>
        </div>
    </div>
</div> 

<script>
    // 1. SETUP ASAS
    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const socket = new WebSocket(protocol + window.location.host + '/ws/queue/{{ queue.slug }}/');
    const AUDIO_BASE_PATH = "/static/audio/"; 

    // 2. AUDIO MANAGER (Engine Bunyi)
    const AudioManager = {
        queue: [],
        isPlaying: false,
        
        // Fungsi untuk terima arahan
        announce: function(ticket, counterName) {
            console.log("ðŸ”Š Memanggil:", ticket);
            this.queue.push({ ticket, counterName });
            this.processQueue(); 
        },

        // Proses giliran bunyi
        processQueue: async function() {
            if (this.isPlaying || this.queue.length === 0) return;
            this.isPlaying = true;
            
            const nextItem = this.queue.shift(); 
            const playlist = this.generatePlaylist(nextItem.ticket, nextItem.counterName);
            
            await this.playSequence(playlist);
        },

        // Generate Playlist (A001 -> a.mp3, 0.mp3...)
        generatePlaylist: function(ticket, counterName) {
            let playlist = ["chime.mp3", "intro.mp3"];
            
            let cleanTicket = ticket.toString().toUpperCase().trim();
            let characters = cleanTicket.split('');
            
            characters.forEach(char => {
                playlist.push(char.toLowerCase() + ".mp3");
            });

            if (counterName) {
                let counterNum = counterName.replace(/[^0-9]/g, '');
                if(counterNum) {
                    playlist.push("sebutan_kaunter.mp3");
                    playlist.push(counterNum + ".mp3");
                } else {
                     playlist.push("kaunter.mp3");
                }
            } else {
                playlist.push("kaunter.mp3");
            }
            return playlist;
        },

        // Mainkan urutan fail
        playSequence: async function(filenames) {
            for (let filename of filenames) {
                await this.playOneFile(filename);
            }
            setTimeout(() => {
                this.isPlaying = false;
                this.processQueue();
            }, 300); 
        },

        // Mainkan satu fail
        playOneFile: function(filename) {
            return new Promise((resolve) => {
                let audio = new Audio(AUDIO_BASE_PATH + filename);
                
                audio.onended = () => resolve();
                
                audio.onerror = (e) => {
                    console.error("âŒ Fail audio tak jumpa:", filename);
                    resolve(); // Teruskan walaupun fail hilang
                };

                let playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.warn("âš ï¸ Audio disekat browser. Sila klik skrin sekali.");
                        resolve();
                    });
                }
            });
        }
    };

    // 3. WEBSOCKET LISTENER
    socket.onopen = () => console.log("âœ… WebSocket Connected");

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        if (data.message === 'invite_next') {
            const payload = data.data;
            let displayNum = payload.ticket || payload.number;

            // Update DOM
            const numEl = document.getElementById('number-text');
            numEl.innerText = displayNum;
            document.getElementById('name-text').innerText = payload.name || "";
            
            const counterEl = document.getElementById('counter-text');
            if (payload.counter) {
                counterEl.style.display = 'block';
                counterEl.innerText = payload.counter.toUpperCase();
            } else {
                counterEl.style.display = 'none';
            }

            // Animasi Pop-in
            numEl.classList.remove('pop-in');
            void numEl.offsetWidth; 
            numEl.classList.add('pop-in');

            // Trigger Audio
            AudioManager.announce(displayNum, payload.counter);
        }
        
        // Update senarai 'Akan Datang' & Waiting Count
        if (data.message === 'queue_update') {
            if (data.data.next_visitors) updateNextList(data.data.next_visitors);
            if (data.data.waiting_count !== undefined) {
                document.getElementById('total-waiting').innerText = data.data.waiting_count;
            }
        }

        // Reset Queue
        if (data.message === 'queue_reset') {
             document.getElementById('number-text').innerText = "---"; 
             document.getElementById('name-text').innerText = "";
             document.getElementById('counter-text').style.display = "none";
             updateNextList([]);
             document.getElementById('total-waiting').innerText = "0";
        }
    };

    socket.onclose = () => {
        console.log("Socket putus. Reconnecting...");
        setTimeout(() => location.reload(), 3000);
    };

    function updateNextList(visitors) {
        const container = document.getElementById('next-list-container');
        if(container) {
            container.innerHTML = "";
            if (!visitors || visitors.length === 0) {
                 container.innerHTML = `
                <div class="next-card"><span class="next-number">-</span></div>
                <div class="next-card"><span class="next-number">-</span></div>
                <div class="next-card"><span class="next-number">-</span></div>`;
            } else {
                visitors.slice(0, 3).forEach(t => {
                    let div = document.createElement('div');
                    div.className = 'next-card'; 
                    div.innerHTML = `<span class="next-number">${t}</span>`;
                    container.appendChild(div);
                });
            }
        }
    }
</script>
{% endblock %}