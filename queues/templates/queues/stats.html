{% extends 'base.html' %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body { background-color: #f3f4f6; }
    .stats-container { max-width: 900px; margin: 30px auto; padding: 20px; }
    
    .stats-header { text-align: center; margin-bottom: 30px; }
    .stats-title { font-size: 2rem; font-weight: 800; color: #1f2937; }
    .stats-date { color: #6b7280; font-size: 1.1rem; }

    /* Cards untuk Total Number */
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
    .card-stat { background: white; padding: 25px; border-radius: 20px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .stat-num { font-size: 3rem; font-weight: 800; color: #3b82f6; line-height: 1; }
    .stat-label { font-size: 0.9rem; text-transform: uppercase; color: #9ca3af; font-weight: 600; margin-top: 5px; }

    /* Chart Containers */
    .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .chart-box { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    
    @media (max-width: 768px) {
        .charts-grid { grid-template-columns: 1fr; }
    }
    
    .btn-back { display: inline-block; margin-top: 30px; text-decoration: none; color: #6b7280; font-weight: 600; }
</style>

<div class="stats-container">

    <div class="stats-header">
        <div class="stats-title">Statistik Harian</div>
        <div class="stats-date">{{ today|date:"l, d F Y" }}</div>
        <div style="margin-top: 5px;">{{ queue.name }}</div>
    </div>

    <div class="summary-grid">
        <div class="card-stat">
            <div class="stat-num">{{ total_today }}</div>
            <div class="stat-label">Jumlah Pelawat</div>
        </div>
        <div class="card-stat">
            <div class="stat-num text-success" style="color: #10b981;">
                <script>document.write({{ chart_status_data }}[0] + {{ chart_status_data }}[1])</script>
            </div>
            <div class="stat-label">Telah Dilayan</div>
        </div>
        <div class="card-stat">
            <div class="stat-num text-warning" style="color: #f59e0b;">
                <script>document.write({{ chart_status_data }}[2])</script>
            </div>
            <div class="stat-label">Masih Menunggu</div>
        </div>
    </div>

    <div class="charts-grid">
        
        <div class="chart-box">
            <h5 class="fw-bold text-center mb-3">Mengikut Servis</h5>
            <canvas id="serviceChart"></canvas>
        </div>

        <div class="chart-box">
            <h5 class="fw-bold text-center mb-3">Status Semasa</h5>
            <canvas id="statusChart"></canvas>
        </div>

        <div class="chart-box" style="grid-column: span 2;"> <h5 class="fw-bold text-center mb-3">Waktu Puncak (Hari Ini)</h5>
            <canvas id="peakChart"></canvas>
        </div>
    </div>

    <div class="text-center">
        <a href="{% url 'admin_interface' queue.slug %}" class="btn-back">‚Üê Kembali ke Admin</a>
    </div>

</div>

<script>
    // --- DATA DARI DJANGO VIEWS ---
    const serviceData = JSON.parse('{{ chart_service_data|safe }}'); // [A, B, C]
    const statusData = JSON.parse('{{ chart_status_data|safe }}');   // [Completed, Serving, Waiting]

    const hoursLabels = JSON.parse('{{ chart_hours_labels|safe }}');
    const hoursData = JSON.parse('{{ chart_hours_data|safe }}');
    // 1. CHART SERVIS (Bar)
    const ctx1 = document.getElementById('serviceChart').getContext('2d');
    new Chart(ctx1, {
        type: 'bar',
        data: {
            labels: ['Pendaftaran (A)', 'Pembayaran (B)', 'Pertanyaan (C)'],
            datasets: [{
                label: 'Jumlah Pelawat',
                data: serviceData,
                backgroundColor: [
                    'rgba(59, 130, 246, 0.7)', // Biru
                    'rgba(16, 185, 129, 0.7)', // Hijau
                    'rgba(139, 92, 246, 0.7)'  // Ungu
                ],
                borderColor: [
                    '#3b82f6', '#10b981', '#8b5cf6'
                ],
                borderWidth: 1,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });

    // 2. CHART STATUS (Doughnut)
    const ctx2 = document.getElementById('statusChart').getContext('2d');
    new Chart(ctx2, {
        type: 'doughnut',
        data: {
            labels: ['Selesai', 'Sedang Dilayan', 'Menunggu'],
            datasets: [{
                data: statusData,
                backgroundColor: [
                    '#10b981', // Hijau (Selesai)
                    '#3b82f6', // Biru (Serving)
                    '#f59e0b'  // Kuning (menunggu))
                ],
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            cutout: '70%',
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });


    const ctx3 = document.getElementById('peakChart').getContext('2d');
    new Chart(ctx3, {
        type: 'line',
        data: {
            labels: hoursLabels,
            datasets: [{
                label: 'Pelawat Masuk',
                data: hoursData,
                borderColor: '#ef4444', // Merah
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4, // Bagi garisan melengkung sikit (smooth)
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
        }
    });


</script>

{% endblock %}