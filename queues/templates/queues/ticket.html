{% extends 'base.html' %}
{% block content %}

<style>
    /* --- 1. LAYOUT UTAMA --- */
    .ticket-container { 
        min-height: 100vh; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        justify-content: center; 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
        background-color: #f8fafc; 
        padding: 20px; 
        overflow: hidden;
    }

    .ticket-logo {
        max-height: 80px; 
        width: auto;       
        max-width: 80%;    
        margin-bottom: 40px; /* Jarak lebih besar dari bulatan */
        object-fit: contain;
    }

    /* --- 2. BULATAN BESAR (The Ring) --- */
    .loader-wrapper {
        position: relative;
        /* --- PERUBAHAN UTAMA: SAIZ DIBESARKAN --- */
        width: 420px;  /* Dibesarkan dari 350px */
        height: 420px; /* Dibesarkan dari 350px */
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 50px;
        background: white;
        border-radius: 50%;
        box-shadow: 0 15px 40px rgba(0,0,0,0.05); 
        z-index: 2;
    }

    /* --- ANIMASI PULSE DI LUAR --- */
    .pulse-bg {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        width: 100%; height: 100%;
        border-radius: 50%;
        background-color: rgba(74, 222, 128, 0.3); 
        z-index: 1; 
        opacity: 0;
    }

    .loader-wrapper.active-pulse .pulse-bg {
        animation: pulse-wave 2.5s infinite ease-out;
    }
    
    .loader-wrapper.active-pulse .pulse-bg:nth-child(1) { animation-delay: 0s; }
    .loader-wrapper.active-pulse .pulse-bg:nth-child(2) { animation-delay: 0.8s; }

    @keyframes pulse-wave {
        0% { transform: translate(-50%, -50%) scale(0.95); opacity: 0.5; }
        100% { transform: translate(-50%, -50%) scale(1.35); opacity: 0; }
    }

    /* --- CINCIN PROGRESS --- */
    .spinner-ring {
        position: absolute;
        width: 100%; height: 100%;
        border-radius: 50%;
        border: 28px solid #f1f5f9; /* Border sedikit tebal */
        box-sizing: border-box;
        z-index: 3;
    }

    /* STYLE WAITING */
    .spinner-ring.waiting {
        border-top-color: #4ade80;  
        border-left-color: #86efac; 
        border-right-color: #f1f5f9; 
        border-bottom-color: #f1f5f9;
        animation: spin 1.5s linear infinite;
    }

    /* STYLE SERVING (HIJAU TERANG) */
    .spinner-ring.serving {
        border-color: #4ade80; 
        box-shadow: inset 0 0 30px rgba(74, 222, 128, 0.2); /* Glow dalam */
        animation: none; 
    }

    /* STYLE COMPLETED */
    .spinner-ring.completed {
        border: 28px solid #cbd5e1; 
        animation: none;
    }

    /* --- ISI TENGAH (TEKS) --- */
    .ticket-content {
        z-index: 4;
        text-align: center;
        /* Padding dalam lebih besar supaya teks tak kena tepi */
        padding: 55px; 
        width: 100%; height: 100%;
        display: flex; flex-direction: column;
        justify-content: center; align-items: center;
        box-sizing: border-box;
        /* Guna gap untuk jarakkan elemen secara konsisten */
        gap: 15px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Typography yang Dibetulkan */
    .text-top { 
        font-size: 1.1rem; 
        color: #94a3b8; /* Warna lebih lembut */
        font-weight: 700; 
        text-transform: uppercase; 
        letter-spacing: 1.5px;
        margin: 0; /* Margin diuruskan oleh gap flex */
    }
    
    .text-number { 
        font-weight: 800; color: #0f172a;
    }

    .text-main { 
        /* Saiz dilaraskan supaya muat */
        font-size: 3.2rem; 
        font-weight: 900; 
        line-height: 1.05; 
        color: #0f172a; 
        margin: 5px 0; /* Sedikit margin atas bawah */
    }
    
    .text-sub { 
        font-size: 1.1rem; 
        color: #64748b; 
        font-weight: 500; 
        line-height: 1.4;
        max-width: 90%;
        margin: 0;
    }

    /* --- 3. BUTANG --- */
    .btn-container { width: 100%; max-width: 350px; z-index: 10; text-align: center; display: flex; flex-direction: column; gap: 15px; }
    
    .btn-notif { 
        background-color: white; color: #3b82f6; border: 2px solid #3b82f6; 
        padding: 15px; border-radius: 50px; font-weight: 700; width: 100%; 
        font-size: 1rem; cursor: pointer; transition: all 0.2s;
    }
    .btn-notif:hover { background-color: #eff6ff; }

    .btn-quit { 
        background: none; border: none; color: #ef4444; font-weight: 700; 
        font-size: 1rem; text-decoration: none; cursor: pointer; 
    }
    .btn-quit:hover { text-decoration: underline; }

    /* --- 4. MODAL (Tiada perubahan) --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 9999; display: flex; justify-content: center; align-items: flex-end; }
    .modal-card { background-color: white; width: 100%; max-width: 500px; border-top-left-radius: 25px; border-top-right-radius: 25px; padding: 40px 30px; text-align: center; position: relative; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: 0 -10px 40px rgba(0,0,0,0.2); }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .close-btn { position: absolute; top: 20px; right: 20px; font-size: 1.8rem; color: #cbd5e1; text-decoration: none; }
    .confetti-icon { font-size: 5rem; margin-bottom: 15px; display: inline-block; animation: pop 0.5s ease-out; }
    .modal-title { font-size: 1.8rem; font-weight: 800; color: #0f172a; margin-bottom: 10px; }
    .modal-desc { color: #64748b; margin-bottom: 30px; font-size: 1.1rem; }
    .btn-good { background-color: #3b82f6; color: white; border: none; padding: 18px; border-radius: 15px; font-weight: 700; width: 100%; font-size: 1.2rem; display: block; text-decoration: none; box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3); }
    @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
</style>

{% if visitor.is_invited %}
<div class="modal-overlay">
    <div class="modal-card">
        <a href="{% url 'acknowledge_invite' visitor.id %}" class="close-btn">&times;</a>
        <div class="confetti-icon">üéâ</div>
        <h3 class="modal-title">It‚Äôs your turn!</h3>
        <p class="modal-desc">You were invited</p>
        <a href="{% url 'acknowledge_invite' visitor.id %}" class="btn-good">Good</a>
    </div>
</div>
{% endif %}

{% if visitor.is_returned %}
<div class="modal-overlay">
    <div class="modal-card">
        <a href="{% url 'acknowledge_return' visitor.id %}" class="close-btn">&times;</a>
        <div class="confetti-icon">‚è≥</div> 
        <h3 class="modal-title">Moved to queue</h3>
        <p class="modal-desc">You were returned to the waiting list</p>
        <a href="{% url 'acknowledge_return' visitor.id %}" class="btn-good">Okay</a>
    </div>
</div>
{% endif %}

<div class="ticket-container">
    {% if queue.logo %}
        <img src="{{ queue.logo.url }}" class="ticket-logo" alt="Queue Logo">
    {% endif %}
    
    <div class="loader-wrapper {% if visitor.status == 'SERVING' or visitor.status == 'WAITING' %}active-pulse{% endif %}">
        
        <div class="pulse-bg"></div>
        <div class="pulse-bg"></div>

        <div class="spinner-ring 
            {% if visitor.status == 'WAITING' %}waiting{% endif %}
            {% if visitor.status == 'SERVING' %}serving{% endif %}
            {% if visitor.status == 'COMPLETED' %}completed{% endif %}
        "></div>

        <div class="ticket-content">
            {% if visitor.status == 'WAITING' %}
                <div class="text-top">
                    Your Number <span class="text-number">#{{ visitor.number|stringformat:"03d" }}</span>
                </div>
                
                <div class="text-main">In Queue</div>
                <div class="text-sub">Please wait for your turn</div>
            
            {% elif visitor.status == 'SERVING' %}
                <div class="text-top">
                    Your Number <span class="text-number">#{{ visitor.number|stringformat:"03d" }}</span>
                </div>
                
                <div class="text-main">
                    It is your<br>turn now!
                </div>
                
                <div class="text-sub">‚Äî you are invited!</div>
            
            {% else %}
                <div class="text-main" style="font-size: 2.8rem;">Completed</div>
                <div class="text-sub">Thank you!</div>
            {% endif %}
        </div>
    </div>

    <div class="btn-container">
        <button onclick="requestNotificationPermission()" class="btn-notif">
            Enable notifications
        </button>
        
        <form action="{% url 'visitor_quit' visitor.id %}" method="POST" onsubmit="return confirm('Are you sure you want to quit?');">
            {% csrf_token %}
            <button type="submit" class="btn-quit">Quit the queue</button>
        </form>
    </div>

</div>

<script>
    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const queueSlug = "{{ queue.slug }}"; 
    const visitorId = parseInt("{{ visitor.id }}");
    const socket = new WebSocket(protocol + window.location.host + '/ws/queue/' + queueSlug + '/');

    socket.onopen = function(e) { console.log("Connected to Queue"); };

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const eventType = data.message;
        const payload = data.data;

        if (eventType === 'invite_next') {
            if (payload.visitor_id === visitorId) {
                showInviteModalJS();
                try { new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3').play(); } catch(e){}
            } else { location.reload(); }
        }

        if (eventType === 'return_queue') {
            if (payload.visitor_id === visitorId) location.reload(); else location.reload();
        }
        
        if (eventType === 'visitor_quit') location.reload();
    };

    socket.onclose = function(e) { setTimeout(function() { location.reload(); }, 5000); };

    function showInviteModalJS() {
        if (document.querySelector('.modal-overlay')) return;
        const modalHtml = `
        <div class="modal-overlay">
            <div class="modal-card">
                <a href="/visitor/${visitorId}/ack-invite/" class="close-btn">&times;</a>
                <div class="confetti-icon">üéâ</div>
                <h3 class="modal-title">It‚Äôs your turn!</h3>
                <p class="modal-desc">You were invited</p>
                <a href="/visitor/${visitorId}/ack-invite/" class="btn-good">Good</a>
            </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }

    function requestNotificationPermission() {
        if ("Notification" in window) {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") { alert("Notifications enabled!"); }
            });
        }
    }
</script>

{% endblock %}