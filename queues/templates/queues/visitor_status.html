{% extends 'base.html' %}
{% block content %}

<style>
    /* --- GLOBAL LAYOUT --- */
    html, body {
        height: 100%; margin: 0; padding: 0;
        background-color: #ffffff;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    /* Wrapper Flexbox: Pastikan footer sentiasa di bawah */
    .app-wrapper {
        display: flex; flex-direction: column;
        height: 100vh; /* Full Height */
        width: 100%;
        overflow: hidden; /* Elak scroll jika tak perlu */
    }

    /* HEADER */
    .location-header {
        flex: 0 0 auto; /* Jangan kecut */
        padding: 15px 0; text-align: center;
        font-size: 0.9rem; font-weight: 600; color: #374151;
        display: flex; justify-content: center; align-items: center; gap: 6px;
        background: white; z-index: 10;
    }

    /* CONTAINER TENGAH (Bulatan) */
    .status-container {
        flex: 1; /* Ambil semua ruang tengah */
        display: flex; flex-direction: column; 
        justify-content: center; align-items: center;
        padding: 20px;
        position: relative;
    }

    /* --- STYLE BULATAN (CSS INI UNTUK CONTENT ANAK) --- */
    .circle-wrapper {
        position: relative;
        width: 300px; height: 300px;
        display: flex; justify-content: center; align-items: center;
    }

    .pulse-ring {
        position: absolute; width: 100%; height: 100%;
        border-radius: 50%;
        background: rgba(59, 130, 246, 0.1); /* Biru */
        z-index: 1; animation: pulseRing 2s infinite;
    }
    .pulse-ring.serving { background: rgba(34, 197, 94, 0.1); /* Hijau */ }

    .main-circle {
        width: 280px; height: 280px;
        background: white; border-radius: 50%;
        border: 15px solid #3b82f6; /* Border Biru Tebal */
        display: flex; flex-direction: column; 
        justify-content: center; align-items: center; text-align: center;
        z-index: 2; box-shadow: 0 10px 40px rgba(59, 130, 246, 0.15);
        position: relative;
    }
    .main-circle.serving { border-color: #22c55e; box-shadow: 0 10px 40px rgba(34, 197, 94, 0.15); }

    /* Font dalam bulatan */
    .txt-top { font-size: 0.9rem; color: #6b7280; margin-bottom: 5px; font-weight: 500; }
    .txt-big { 
        font-size: 3.5rem; /* SANGAT BESAR */
        font-weight: 800; color: #111827; 
        line-height: 1; margin: 5px 0; letter-spacing: -1px;
    }
    .serving-text { color: #22c55e; font-size: 2.8rem; }
    .done-text { color: #9ca3af; font-size: 2.5rem; }
    
    .txt-sub { font-size: 1.1rem; color: #4b5563; margin-top: 5px; font-weight: 500; }
    .divider { width: 40px; height: 3px; background: #e5e7eb; margin: 10px 0; border-radius: 2px; }

    /* FOOTER (Butang) */
    .action-footer {
        flex: 0 0 auto; /* Jangan kecut */
        padding: 20px; background: white;
        display: flex; flex-direction: column; gap: 10px;
        padding-bottom: max(20px, env(safe-area-inset-bottom));
    }

    /* BUTANG STYLE */
    .btn-action {
        width: 100%; padding: 18px;
        border-radius: 16px; font-weight: 700; text-decoration: none; 
        display: flex; justify-content: center; align-items: center; gap: 10px;
        text-align: center; cursor: pointer; transition: all 0.2s; font-size: 1rem; border: none;
    }
    .btn-action:active { transform: scale(0.96); }
    .btn-blue { background-color: #3b82f6; color: white; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
    .btn-green { background-color: #10b981; color: white; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
    .btn-gray { background-color: #f3f4f6; color: #6b7280; }
    
    /* ANIMASI */
    @keyframes pulseRing { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(1.3); opacity: 0; } }

    /* MODAL */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 2000;
        display: none; justify-content: center; align-items: center;
        backdrop-filter: blur(5px);
    }
    .modal-card {
        background: white; width: 85%; max-width: 320px;
        padding: 30px; border-radius: 24px; text-align: center;
        animation: popUp 0.3s ease-out;
    }
    @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
</style>

<div class="app-wrapper">
    
    <div class="location-header">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
        <span>{{ queue.name }}</span>
    </div>

    <div class="status-container"
         id="status-content"
         hx-get="{% url 'visitor_status' visitor.id %}"
         hx-trigger="every 5s, queue_update from:body">
         
        {% include 'queues/partials/visitor_status_content.html' %}
        
    </div>

    <div class="action-footer">
        {% if visitor.status == 'WAITING' %}
            <button id="btn-enable-notif" class="btn-action btn-blue" onclick="enableSmartAlerts()">
                <span>üîî</span> Aktifkan Notifikasi
            </button>
            <a href="{% url 'visitor_quit' visitor.id %}" onclick="return confirm('Keluar barisan?');" class="btn-action btn-gray">
                Keluar dari Q
            </a>
        {% endif %}
    </div>

</div>

<div id="returnModal" class="modal-overlay">
    <div class="modal-card">
        <div style="font-size: 4rem;">‚è≥</div>
        <h2>Masuk Q Semula</h2>
        <p style="color:#666;">Anda telah dipindahkan kembali ke dalam barisan.</p>
        <button onclick="closeModal('returnModal')" class="btn-action btn-blue">Faham</button>
    </div>
</div>

<div id="inviteModal" class="modal-overlay">
    <div class="modal-card">
        <div style="font-size: 4rem;">üéâ</div>
        <h2>Giliran Anda!</h2>
        <p style="color:#666;">Sila hadir ke kaunter sekarang.</p>
        <button onclick="closeModal('inviteModal')" class="btn-action btn-blue">Saya Datang</button>
    </div>
</div>

<audio id="alertSound" preload="auto">
    <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
</audio>

<script>
    const currentVisitorId = "{{ visitor.id }}"; 
    const alertSound = document.getElementById('alertSound');
    let wakeLock = null;

    // --- 1. FUNGSI SETUP ALERTS (DIPERBAIKI) ---
    function enableSmartAlerts() {
        const btn = document.getElementById('btn-enable-notif');
        
        // A. UNLOCK AUDIO (PENTING: MESTI JALAN TERUS TANPA AWAIT)
        // Kita paksa main dan pause serta-merta bila user tekan butang.
        // Jangan letak dalam try-catch block yang kompleks.
        alertSound.muted = true; // Mute dulu untuk trick browser
        alertSound.play().then(() => {
            // Kalau berjaya main
            alertSound.pause();
            alertSound.currentTime = 0;
            alertSound.muted = false; // Unmute semula untuk standby
            alertSound.volume = 1.0;
            console.log("Audio unlocked successfully");
        }).catch(error => {
            console.warn("Audio autoplay prevented:", error);
            alert("Sila pastikan telefon anda tidak dalam mod 'Silent'.");
        });

        // Update butang UI dulu supaya user nampak respons
        btn.innerHTML = "‚úÖ Notifikasi Aktif";
        btn.classList.remove('btn-blue', 'pulse-btn');
        btn.classList.add('btn-green');
        btn.disabled = true;

        // B. SETUP LAIN (Notification & WakeLock) - Jalan di background
        setupBackgroundTasks();
    }

    async function setupBackgroundTasks() {
        // Minta izin Notification
        if ("Notification" in window) {
            await Notification.requestPermission();
        }

        // Minta Screen Wake Lock (Supaya skrin tak padam)
        try {
            if ('wakeLock' in navigator) {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log("Wake Lock active");
                
                // Re-acquire lock jika user minimize dan buka balik app
                document.addEventListener('visibilitychange', async () => {
                    if (wakeLock !== null && document.visibilityState === 'visible') {
                        wakeLock = await navigator.wakeLock.request('screen');
                    }
                });
            }
        } catch (err) {
            console.log("Wake Lock error:", err);
        }
    }

    // --- 2. FUNGSI TRIGGER (BUNYI + VIBRATE) ---
    function triggerItIsYourTurn() {
        // A. Mainkan Bunyi (Sekarang browser patut dah benarkan)
        let playPromise = alertSound.play();
        
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                console.error("Gagal main bunyi:", error);
                // Fallback: Cuba main sekali lagi jika gagal
                alertSound.muted = false;
                alertSound.play();
            });
        }

        // B. Vibrate (Untuk Android)
        if (navigator.vibrate) {
            navigator.vibrate([500, 200, 500, 200, 1000]);
        }
        
        // C. Push Notification
        if (Notification.permission === "granted") {
            const notif = new Notification("Giliran Anda!", {
                body: "Sila ke kaunter sekarang. Nombor #{{ visitor.ticket_number }}",
                icon: "{% if queue.logo %}{{ queue.logo.url }}{% endif %}",
                vibrate: [200, 100, 200],
                requireInteraction: true
            });
            notif.onclick = function() {
                window.focus();
                notif.close();
            };
        }

        // D. Tunjuk Modal
        document.getElementById('inviteModal').style.display = 'flex';
    }

    // --- 3. WEBSOCKET LOGIC ---
    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const socket = new WebSocket(protocol + window.location.host + '/ws/queue/{{ queue.slug }}/');

    socket.onopen = () => console.log("WebSocket Connected");

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const eventType = data.message;
        const payload = data.data;

        // Refresh UI (HTMX)
        document.body.dispatchEvent(new Event('queue_update'));

        // Check ID Pelawat
        if (payload.visitor_id == currentVisitorId) {
            if (eventType === 'visitor_returned') {
                document.getElementById('returnModal').style.display = 'flex';
            }
            if (eventType === 'invite_next') {
                triggerItIsYourTurn();
            }
        }
    };
    
    socket.onclose = () => {
        console.log("Socket putus. Reconnecting...");
        setTimeout(() => location.reload(), 3000);
    };

    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
        alertSound.pause();
        alertSound.currentTime = 0;
    }
</script>
{% endblock %}