{% extends 'base.html' %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
    /* --- GLOBAL & BACKGROUND --- */
    html, body {
        height: 100%; margin: 0; padding: 0;
        background-color: #f0f4f8;
        background-image: 
            radial-gradient(at 0% 0%, hsla(253,16%,7%,0) 0, hsla(253,16%,7%,0) 50%), 
            radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, hsla(225,39%,30%,0) 50%), 
            radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, hsla(339,49%,30%,0) 50%);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        color: #1e293b;
    }

    .app-wrapper {
        display: flex; flex-direction: column;
        height: 100vh; width: 100%; overflow: hidden;
        background: rgba(255, 255, 255, 0.85); /* Overlay Putih */
        backdrop-filter: blur(50px);
    }

    /* HEADER */
    .location-header {
        flex: 0 0 auto; padding: 20px 0; text-align: center;
        font-size: 0.85rem; font-weight: 700; color: #64748b;
        text-transform: uppercase; letter-spacing: 1.5px;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    /* CONTAINER TENGAH */
    .status-container {
        flex: 1; display: flex; flex-direction: column; 
        justify-content: center; align-items: center;
        position: relative; width: 100%;
    }

    /* --- BULATAN MODEN (KEKAL / STATIC) --- */
    .circle-wrapper {
        position: relative;
        width: 320px; height: 320px;
        display: flex; justify-content: center; align-items: center;
    }

    /* SVG RING */
    .progress-ring {
        position: absolute; top: 0; left: 0;
        width: 100%; height: 100%;
        transform: rotate(90deg); /* Mula bawah */
        z-index: 1;
        filter: drop-shadow(0 10px 20px rgba(37, 99, 235, 0.15));
    }

    .progress-ring__circle {
        transition: stroke-dashoffset 1s cubic-bezier(0.4, 0, 0.2, 1), stroke 0.5s ease;
        transform-origin: 50% 50%;
        stroke-linecap: round;
    }

    /* KANDUNGAN TEKS (YANG AKAN BERUBAH) */
    .circle-content {
        z-index: 2; position: absolute;
        width: 260px; height: 260px;
        border-radius: 50%;
        background: white;
        box-shadow: inset 0 0 40px rgba(0,0,0,0.02);
        display: flex; flex-direction: column;
        justify-content: center; align-items: center; text-align: center;
    }

    /* DEFINISI WARNA (CSS VARIABLES) */
    :root {
        --color-waiting-start: #60a5fa;
        --color-waiting-end: #2563eb;
        --color-serving-start: #4ade80;
        --color-serving-end: #16a34a;
    }

    /* FOOTER */
    .action-footer {
        flex: 0 0 auto; padding: 25px; 
        background: white;
        border-radius: 30px 30px 0 0;
        box-shadow: 0 -10px 40px rgba(0,0,0,0.05);
        display: flex; flex-direction: column; gap: 15px;
        padding-bottom: max(25px, env(safe-area-inset-bottom));
    }

    .btn-action {
        width: 100%; padding: 18px; border-radius: 16px; 
        font-weight: 700; font-size: 1rem; border: none;
        display: flex; justify-content: center; align-items: center; gap: 10px;
        cursor: pointer; transition: transform 0.1s; text-decoration: none;
    }
    .btn-action:active { transform: scale(0.98); }
    
    .btn-blue { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); }
    .btn-green { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3); }
    .btn-gray { background: #f1f5f9; color: #64748b; }

    /* MODAL */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(8px);
        z-index: 2000; display: none; justify-content: center; align-items: center;
    }
    .modal-card {
        background: white; width: 85%; max-width: 320px;
        padding: 40px 30px; border-radius: 30px; text-align: center;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        animation: popUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
</style>

<div class="app-wrapper">
    
    <div class="location-header">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right:6px"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
        {{ queue.name }}
    </div>

    <div class="status-container">
        
        <div class="circle-wrapper">
            
            <svg class="progress-ring" viewBox="0 0 120 120">
                <defs>
                    <linearGradient id="blueGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#60a5fa" />
                        <stop offset="100%" stop-color="#2563eb" />
                    </linearGradient>
                    <linearGradient id="greenGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#4ade80" />
                        <stop offset="100%" stop-color="#16a34a" />
                    </linearGradient>
                </defs>

                <circle cx="60" cy="60" r="54" fill="none" stroke="#e2e8f0" stroke-width="8" />
                
                <circle id="ring-circle" 
                        class="progress-ring__circle"
                        cx="60" cy="60" r="54" 
                        fill="none" 
                        stroke="url(#blueGradient)"
                        stroke-width="8"
                        pathLength="100" 
                        stroke-dasharray="100 100"
                        stroke-dashoffset="100" /> </svg>

            <div class="circle-content"
                 id="dynamic-content"
                 hx-get="{% url 'visitor_status' visitor.id %}"
                 hx-trigger="every 5s, queue_update from:body">
                 
                 {% include 'queues/partials/visitor_status_content.html' %}
                 
            </div>
        </div>

    </div>

    <div class="action-footer" hx-boost="false">
        {% if visitor.status == 'WAITING' %}
            <button id="btn-enable-notif" class="btn-action btn-blue" onclick="enableSmartAlerts()">
                <span>üîî</span> Aktifkan Notifikasi
            </button>
            <a href="{% url 'visitor_quit' visitor.id %}" onclick="return confirm('Pasti mahu keluar?');" class="btn-action btn-gray">
                Keluar dari Q
            </a>
        {% endif %}
    </div>

</div>

<div id="returnModal" class="modal-overlay">
    <div class="modal-card">
        <div style="font-size: 3.5rem;">‚è≥</div>
        <h2 style="margin:10px 0; color:#1e293b;">Masuk Q Semula</h2>
        <p style="color:#64748b; margin-bottom:20px;">Anda telah dipindahkan ke dalam barisan.</p>
        <button onclick="closeModal('returnModal')" class="btn-action btn-blue">Ok</button>
    </div>
</div>

<div id="inviteModal" class="modal-overlay">
    <div class="modal-card">
        <div style="font-size: 3.5rem;">üéâ</div>
        <h2 style="margin:10px 0; color:#1e293b;">Giliran Anda!</h2>
        <p style="color:#64748b; margin-bottom:20px;">Sila hadir ke kaunter sekarang.</p>
        <button onclick="closeModal('inviteModal')" class="btn-action btn-green">Saya Datang</button>
    </div>
</div>

<audio id="alertSound" preload="auto">
    <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
</audio>

<script>
    const currentVisitorId = "{{ visitor.id }}"; 
    const alertSound = document.getElementById('alertSound');
    const ringCircle = document.getElementById('ring-circle');
    let wakeLock = null;

    // --- LOGIK UI & ANIMASI ---
    function updateRingState(status) {
        const footer = document.querySelector('.action-footer');
        
        // 1. Status: SERVING (Giliran Tiba)
        if (status === 'SERVING') {
            ringCircle.style.stroke = "url(#greenGradient)";
            ringCircle.style.strokeDashoffset = "0"; 
            ringCircle.style.filter = "drop-shadow(0 0 15px rgba(34, 197, 94, 0.6))";
            
            // Sembunyikan butang sebab dah dipanggil
            if(footer) footer.style.display = 'none'; 
        } 
        
        // 2. Status: COMPLETED (Selesai)
        else if (status === 'COMPLETED') {
            ringCircle.style.stroke = "#cbd5e1"; // Warna Kelabu
            ringCircle.style.strokeDashoffset = "0";
            ringCircle.style.filter = "none";
            
            // Sembunyikan butang sebab dah selesai
            if(footer) footer.style.display = 'none';
        }
        
        // 3. Status: WAITING (Masih Menunggu)
        else {
            ringCircle.style.stroke = "url(#blueGradient)";
            ringCircle.style.strokeDashoffset = "0"; 
            ringCircle.style.filter = "drop-shadow(0 10px 20px rgba(37, 99, 235, 0.15))";
            
            // Tunjuk butang semula (contohnya kalau staff tekan 'Return to Queue')
            if(footer) footer.style.display = 'flex';
        }
    }

    // Dengar event HTMX untuk update ring
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        const newStatus = document.getElementById('status-hidden-input')?.value;
        if(newStatus) updateRingState(newStatus);
    });

    // Jalankan sekali masa mula-mula load
    setTimeout(() => {
        // Efek gerak dari kosong ke penuh masa mula buka page
        ringCircle.style.transition = "stroke-dashoffset 1.5s ease-out";
        updateRingState("{{ visitor.status }}");
    }, 100);


    // --- SETUP ALERTS ---
    function enableSmartAlerts() {
        const btn = document.getElementById('btn-enable-notif');
        btn.innerHTML = "‚è≥ Mengaktifkan...";
        
        alertSound.muted = true;
        alertSound.play().then(() => {
            alertSound.pause(); alertSound.currentTime = 0;
            alertSound.muted = false; alertSound.volume = 1.0;
        }).catch(() => alert("Sila pastikan telefon tidak Silent."));

        if ("Notification" in window) Notification.requestPermission();
        requestWakeLock();

        btn.innerHTML = "‚úÖ Notifikasi Aktif";
        btn.classList.replace('btn-blue', 'btn-green');
        btn.disabled = true;
    }

    async function requestWakeLock() {
        try {
            if ('wakeLock' in navigator) {
                wakeLock = await navigator.wakeLock.request('screen');
                document.addEventListener('visibilitychange', async () => {
                    if (wakeLock !== null && document.visibilityState === 'visible') {
                        wakeLock = await navigator.wakeLock.request('screen');
                    }
                });
            }
        } catch(e) {}
    }

    function triggerItIsYourTurn() {
        alertSound.play().catch(() => {});
        if (navigator.vibrate) navigator.vibrate([500, 300, 500]);
        
        confetti({
            origin: { y: 0.7 }, spread: 60, particleCount: 100,
            colors: ['#22c55e', '#3b82f6', '#f59e0b']
        });

        document.getElementById('inviteModal').style.display = 'flex';
    }

    // --- WEBSOCKET ---
    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const socket = new WebSocket(protocol + window.location.host + '/ws/queue/{{ queue.slug }}/');

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const payload = data.data;

        // Trigger HTMX refresh
        document.body.dispatchEvent(new Event('queue_update'));

        if (payload.visitor_id == currentVisitorId) {
            if (data.message === 'visitor_returned') {
                document.getElementById('returnModal').style.display = 'flex';
            }
            if (data.message === 'invite_next') {
                triggerItIsYourTurn();
            }
        }
    };
    
    socket.onclose = () => setTimeout(() => location.reload(), 3000);

    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
        alertSound.pause(); alertSound.currentTime = 0;
    }
</script>
{% endblock %}