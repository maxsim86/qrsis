{% extends 'base.html' %}
{% block content %}
<script src="https://unpkg.com/htmx.org@1.9.10"></script>

<style>
    /* --- GLOBAL STYLES --- */
    body { background-color: #f9fafb; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overflow-x: hidden; }

    /* Header Lokasi */
    .location-header {
        position: absolute; top: 20px; width: 100%; text-align: center;
        font-size: 0.9rem; font-weight: 500; color: #374151; 
        display: flex; justify-content: center; align-items: center; gap: 6px;
        z-index: 10;
    }

    /* Container Utama */
    .status-container {
        min-height: 100vh;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        text-align: center; padding: 20px;
        position: relative;
    }

    /* --- BULATAN STATUS (Style Seperti Gambar) --- */
    .status-wrapper { position: relative; display: flex; justify-content: center; align-items: center; margin-bottom: 40px; }
    
    /* Latar Belakang Blob (Hiasan) */
    .blob-bg {
        position: absolute;
        width: 320px; height: 320px;
        background: #eff6ff; /* Very Light Blue */
        border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
        z-index: 1;
        animation: morph 6s ease-in-out infinite;
    }

    /* Bulatan Utama */
    .circle-card {
        width: 260px; height: 260px;
        background: white;
        border-radius: 50%;
        border: 12px solid #3b82f6; /* Blue Border Tebal */
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        box-shadow: 0 10px 30px rgba(59, 130, 246, 0.15);
        z-index: 2;
        position: relative;
    }
    
    .circle-card.serving { border-color: #22c55e; /* Hijau bila giliran sampai */ }

    .text-top { font-size: 0.9rem; color: #6b7280; font-weight: 500; margin-bottom: 5px; }
    .text-top strong { color: #111827; }

    .text-main { 
        font-size: 2.2rem; font-weight: 800; color: #111827; line-height: 1.1; 
        padding: 0 10px;
    }
    
    .text-sub { 
        font-size: 1rem; color: #4b5563; margin-top: 10px; 
        display: flex; align-items: center; gap: 5px;
    }
    .divider-line { width: 20px; height: 2px; background: #d1d5db; display: inline-block; }

    /* --- BUTTONS --- */
    .btn-action {
        width: 100%; max-width: 280px; padding: 14px;
        border-radius: 12px; font-weight: 600; text-decoration: none; display: block; margin-bottom: 12px;
        text-align: center; cursor: pointer; transition: transform 0.1s; font-size: 1rem;
    }
    .btn-action:active { transform: scale(0.98); }
    .btn-blue { background-color: #3b82f6; color: white; border: none; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
    .btn-gray { background-color: #f3f4f6; color: #4b5563; border: none; }

    /* --- MODALS (Return & Invite) --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); z-index: 1000;
        display: none; justify-content: center; align-items: center;
        backdrop-filter: blur(4px);
    }
    .modal-card {
        background: white; width: 85%; max-width: 350px;
        padding: 30px; border-radius: 24px; text-align: center;
        box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        animation: popUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .modal-icon-img { width: 80px; height: 80px; margin-bottom: 15px; object-fit: contain; }
    .modal-emoji { font-size: 4rem; margin-bottom: 10px; display: block; }
    
    .modal-h { font-size: 1.4rem; font-weight: 800; color: #111827; margin-bottom: 8px; }
    .modal-p { color: #6b7280; font-size: 1rem; margin-bottom: 25px; line-height: 1.5; }

    @keyframes morph {
        0%, 100% { border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; transform: rotate(0deg); }
        34% { border-radius: 70% 30% 50% 50% / 30% 30% 70% 70%; transform: rotate(5deg); }
        67% { border-radius: 100% 60% 60% 100% / 100% 100% 60% 60%; transform: rotate(-5deg); }
    }
    @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
</style>

<div class="location-header">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
    {{ queue.name }}
</div>

<div class="status-container"
     id="status-content"
     hx-get="{% url 'visitor_status' visitor.id %}"
     hx-trigger="every 3s, queue_update from:body">

    {% include 'queues/partials/visitor_status_content.html' %}

</div>

<div id="returnModal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-emoji">‚è≥</div>
        <div class="modal-h">You were moved to queue</div>
        <div class="modal-p">Please, wait for your turn</div>
        <button onclick="closeModal('returnModal')" class="btn-action btn-blue">Good</button>
    </div>
</div>

<div id="inviteModal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-emoji">üéâ</div>
        <div class="modal-h">It's your turn!</div>
        <div class="modal-p">Please proceed to the counter</div>
        <button onclick="closeModal('inviteModal')" class="btn-action btn-blue">On my way</button>
    </div>
</div>


<audio id="alertSound" preload="auto">
    <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
</audio>

{% if visitor.status == 'WAITING' %}
    <button id="btn-enable-notif" class="btn-action btn-blue" onclick="enableSmartAlerts()">
        üîî Enable Notifications & Keep Awake
    </button>
    <a href="{% url 'visitor_quit' visitor.id %}" class="btn-action btn-gray">Quit the queue</a>
{% endif %}


<script>
    const currentVisitorId = "{{ visitor.id }}"; 
    const alertSound = document.getElementById('alertSound');
    let wakeLock = null;

    // --- 1. SETUP SMART ALERTS ---
    async function enableSmartAlerts() {
        const btn = document.getElementById('btn-enable-notif');
        
        // A. Minta Izin Notification System
        if ("Notification" in window) {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    console.log("Notification granted");
                }
            });
        }

        // B. 'Unlock' Audio pada iOS/Android
        // Browser mobile tak bagi bunyi auto-play melainkan user tekan sesuatu dulu.
        // Kita mainkan bunyi senyap (mute) sekejap.
        alertSound.volume = 0;
        alertSound.play().then(() => {
            alertSound.pause();
            alertSound.currentTime = 0;
            alertSound.volume = 1.0; // Set balik volume kuat
        }).catch(e => console.log("Audio permission error:", e));

        // C. Aktifkan WAKE LOCK (Supaya skrin tak gelap)
        try {
            if ('wakeLock' in navigator) {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('Screen Wake Lock active');
                btn.innerText = "‚úÖ Notifications Active (Do not close tab)";
                btn.style.backgroundColor = "#22c55e"; // Tukar jadi hijau
                
                // Jika user minimize dan masuk balik, request semula
                document.addEventListener('visibilitychange', async () => {
                    if (wakeLock !== null && document.visibilityState === 'visible') {
                        wakeLock = await navigator.wakeLock.request('screen');
                    }
                });
            } else {
                alert("Sila pastikan skrin anda sentiasa menyala.");
            }
        } catch (err) {
            console.error(`${err.name}, ${err.message}`);
        }
    }

    // --- 2. FUNGSI TRIGGER ALERT (BUNYI + GEGAR + NOTIF) ---
    function triggerItIsYourTurn() {
        // A. Bunyi
        alertSound.play().catch(e => console.log("Gagal main bunyi:", e));

        // B. Getaran (Vibration) - Android Only
        if (navigator.vibrate) {
            navigator.vibrate([500, 200, 500, 200, 1000]); // Corak getaran: Vroom... Vroom... VROOOOM
        }

        // C. System Notification (Lock Screen)
        if (Notification.permission === "granted") {
    const notif = new Notification("Giliran Anda!", {
        body: "Sila ke kaunter sekarang. Nombor anda #{{ visitor.number|stringformat:'03d' }}",
        
        // --- UBAH JADI MACAM NI ---
        // Kita cek dulu: Kalau ada logo, baru ambil URL. Kalau tak, biar kosong string.
        icon: "{% if queue.logo %}{{ queue.logo.url }}{% endif %}",
        // --------------------------
        
        vibrate: [200, 100, 200]
    });
            
            // Bila user tekan notif, buka balik browser
            notif.onclick = function() {
                window.focus();
                notif.close();
            };
        }

        // D. Tunjuk Modal dalam UI
        document.getElementById('inviteModal').style.display = 'flex';
    }

    // --- 3. WEBSOCKET LOGIC ---
    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const queueSlug = "{{ queue.slug }}"; 
    const socket = new WebSocket(protocol + window.location.host + '/ws/queue/' + queueSlug + '/');

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const eventType = data.message;
        const payload = data.data;

        // Refresh Visual (HTMX)
        document.body.dispatchEvent(new Event('queue_update'));

        // Logic Modal & Bunyi
        if (eventType === 'visitor_returned' && payload.visitor_id == currentVisitorId) {
            document.getElementById('returnModal').style.display = 'flex';
        }

        // TRIGGER ALARM DISINI
        if (eventType === 'invite_next' && payload.visitor_id == currentVisitorId) {
            triggerItIsYourTurn();
        }
    };
    
    // Auto-reconnect jika socket putus (sebab skrin terpadam lama)
    socket.onclose = function() {
        console.log("Socket putus, cuba connect semula...");
        setTimeout(() => {
            window.location.reload(); // Reload page terus paling selamat
        }, 3000);
    };

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
        alertSound.pause(); // Stop bunyi bila user tekan 'On my way'
        alertSound.currentTime = 0;
        document.body.dispatchEvent(new Event('queue_update'));
    }
</script>
{% endblock %}